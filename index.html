<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üöÄ AIÂØπËØùÂàÜÊûêÂ∑•ÂÖ∑ - Áªü‰∏ÄÂàÜÊûêÂπ≥Âè∞</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            height: 100%;
            overflow-y: auto;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            color: #2c3e50;
            line-height: 1.6;
            overflow-y: auto;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 15px;
        }

        .header {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 25px;
            padding: 20px 0;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }

        .header h1 {
            font-size: 2.2rem;
            margin-bottom: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header p {
            font-size: 1.2rem;
            color: #5a6c7d;
            font-weight: 300;
        }

        /* Áªü‰∏ÄËæìÂÖ•Âå∫Âüü */
        .unified-input {
            background: white;
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .input-header {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-bottom: 25px;
        }

        .input-header h2 {
            color: #2c3e50;
            font-size: 1.8rem;
        }

        .input-tabs {
            display: flex;
            gap: 10px;
        }

        .input-tab {
            background: #f8f9fa;
            border: 2px solid #e1e8ed;
            color: #5a6c7d;
            padding: 12px 24px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .input-tab:hover {
            background: #e9ecef;
        }

        .input-tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
        }

        .input-mode {
            display: none;
        }

        .input-mode.active {
            display: block !important;
        }

        /* ÊâπÈáèÂàÜÊûêÊ†∑Âºè */
        .batch-input-section {
            margin-bottom: 30px;
        }
        
        .input-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            color: white;
        }
        
        .input-section-header h3 {
            color: white;
            font-size: 1.4rem;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .batch-url-container {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            border: 2px dashed #dee2e6;
            transition: all 0.3s ease;
        }
        
        /* Ê®™ÂêëÂ∏ÉÂ±ÄÊ†∑Âºè */
        .url-inputs-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 15px;
        }
        
        .batch-paste-section, .manual-add-section {
            background: white;
            border-radius: 12px;
            padding: 15px;
            border: 1px solid #e1e8ed;
            height: fit-content;
        }
        
        .or-divider {
            display: none;
        }
        
        @media (max-width: 768px) {
            .url-inputs-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .batch-url-container:hover {
            border-color: #667eea;
            background: #f0f4ff;
        }
        
        .url-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .url-item {
            display: flex;
            gap: 12px;
            align-items: center;
            background: white;
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #e1e8ed;
            transition: all 0.3s ease;
        }
        
        .url-item:hover {
            border-color: #667eea;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.1);
        }
        
        .url-item input {
            flex: 1;
            border: none;
            background: transparent;
            font-size: 14px;
            padding: 8px;
        }
        
        .url-item input:focus {
            outline: none;
            background: #f8f9fa;
        }
        
        .url-counter {
            background: #667eea;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }
        
        .add-url-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }
        
        .add-url-btn:hover {
            background: #218838;
            transform: translateY(-1px);
        }
        
        .paste-hint {
            text-align: center;
            color: #6c757d;
            font-size: 13px;
            margin-top: 15px;
            font-style: italic;
        }
        
        .batch-paste-section {
            background: white;
            border-radius: 12px;
            padding: 20px;
            border: 2px solid #e1e8ed;
            margin-bottom: 20px;
        }
        
        .paste-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .paste-header h4 {
            margin: 0;
            color: #2c3e50;
            font-size: 1.1rem;
        }
        
        .parse-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 13px;
            transition: all 0.3s ease;
        }
        
        .parse-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }
        
        .batch-paste-input {
            width: 100%;
            min-height: 120px;
            padding: 15px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            font-size: 14px;
            font-family: 'Monaco', 'Courier New', monospace;
            resize: vertical;
            transition: border-color 0.3s ease;
        }
        
        .batch-paste-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .manual-add-section {
            background: white;
            border-radius: 12px;
            padding: 20px;
            border: 2px solid #e1e8ed;
        }
        
        .manual-add-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .manual-add-header h4 {
            margin: 0;
            color: #2c3e50;
            font-size: 1.1rem;
        }
        
        .url-count-badge {
            background: #667eea;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 10px;
        }

        .small-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: background 0.3s ease;
        }

        .small-btn:hover {
            background: #218838;
        }

        .remove-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: background 0.3s ease;
        }

        .remove-btn:hover {
            background: #c82333;
        }

        .url-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 20px;
        }

        .url-item {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .url-item input {
            flex: 1;
        }

        .batch-url-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .batch-url-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .or-divider {
            text-align: center;
            margin: 20px 0;
            position: relative;
            color: #6c757d;
        }

        .or-divider::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 1px;
            background: #e1e8ed;
            z-index: 1;
        }

        .or-divider span {
            background: white;
            padding: 0 15px;
            position: relative;
            z-index: 2;
        }

        .batch-json-input {
            width: 100%;
            min-height: 150px;
            padding: 15px;
            border: 2px solid #e1e8ed;
            border-radius: 10px;
            font-size: 14px;
            font-family: 'Monaco', 'Courier New', monospace;
            resize: vertical;
            transition: border-color 0.3s ease;
        }

        .batch-json-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .analysis-controls {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            gap: 20px;
            padding: 20px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 15px;
            margin: 15px 0;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            flex-wrap: wrap;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .control-group.timezone-selector {
            flex-direction: row;
            align-items: center;
            gap: 12px;
        }

        .control-group.analysis-type {
            flex-direction: row;
            align-items: center;
            gap: 15px;
        }

        .checkbox-group {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            align-items: center;
        }

        .control-group label {
            font-weight: 600;
            color: #2c3e50;
            font-size: 14px;
        }

        .checkbox-group {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            font-size: 13px;
            color: #495057;
            padding: 6px 14px;
            border: 2px solid #e9ecef;
            border-radius: 16px;
            background: #f8f9fa;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .checkbox-label:hover {
            border-color: #3498db;
            background: #e3f2fd;
            transform: translateY(-1px);
        }

        .checkbox-label input[type="checkbox"] {
            width: auto;
            margin: 0;
            appearance: none;
            width: 14px;
            height: 14px;
            border: 2px solid #dee2e6;
            border-radius: 3px;
            background: white;
            position: relative;
            transition: all 0.3s ease;
        }

        .checkbox-label input[type="checkbox"]:checked {
            background: #3498db;
            border-color: #3498db;
        }

        .checkbox-label input[type="checkbox"]:checked::after {
            content: '‚úì';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 10px;
            font-weight: bold;
        }

        .checkbox-label:has(input[type="checkbox"]:checked) {
            border-color: #3498db;
            background: #3498db;
            color: white;
        }

        /* ÂçïÊ¨°ÂàÜÊûêÊ†∑Âºè */
        .single-input-section {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .input-methods {
            display: flex;
            gap: 20px;
            margin-bottom: 25px;
        }

        .input-method {
            flex: 1;
            padding: 20px;
            border: 2px solid #e1e8ed;
            border-radius: 15px;
            background: #f8f9fa;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .input-method.active {
            border-color: #667eea;
            background: white;
            box-shadow: 0 4px 20px rgba(102, 126, 234, 0.1);
        }

        .input-method h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.2rem;
        }

        .input-controls {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .url-input, .json-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e1e8ed;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s ease;
            font-family: inherit;
        }

        .url-input:focus, .json-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .json-input {
            min-height: 120px;
            resize: vertical;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 14px;
        }

        .analyze-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            align-self: flex-start;
        }

        .analyze-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .analyze-btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .status-message {
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            font-weight: 500;
            display: none;
        }

        .status-message.loading {
            background: #e3f2fd;
            color: #1976d2;
            border: 1px solid #bbdefb;
            display: block;
        }

        .status-message.success {
            background: #e8f5e8;
            color: #2e7d32;
            border: 1px solid #c8e6c9;
            display: block;
        }

        .status-message.error {
            background: #ffebee;
            color: #c62828;
            border: 1px solid #ffcdd2;
            display: block;
        }

        /* ÁªìÊûúÂ±ïÁ§∫Âå∫Âüü */
        .results-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }
        
        .results-container.single-mode {
            grid-template-columns: 1fr;
        }
        
        .results-container.single-mode .result-section {
            grid-column: 1 / -1;
        }

        .result-section {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .result-section.full-width {
            grid-column: 1 / -1;
        }

        .result-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f1f3f4;
        }

        .result-header h2 {
            color: #2c3e50;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .result-actions {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* ÊâπÈáèÂàÜÊûêÁªìÊûúÊ†∑Âºè */
        .batch-summary {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 25px;
            border: 2px solid #e1e8ed;
        }

        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }

        .summary-stat {
            text-align: center;
        }

        .summary-stat-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: #667eea;
        }

        .summary-stat-label {
            font-size: 12px;
            color: #6c757d;
            margin-top: 5px;
        }

        .batch-items-container {
            display: grid;
            gap: 20px;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
        }

        .batch-item {
            background: white;
            border-radius: 20px;
            border: 2px solid #e1e8ed;
            overflow: hidden;
            transition: all 0.3s ease;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }

        .batch-item:hover {
            border-color: #667eea;
            box-shadow: 0 8px 30px rgba(102, 126, 234, 0.15);
            transform: translateY(-2px);
        }

        .batch-item-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 25px;
            border-bottom: none;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .batch-item-title {
            font-weight: 600;
            color: white;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .batch-item-title .source-title {
            color: white;
            text-decoration: none;
            transition: all 0.3s ease;
            border-bottom: 1px solid transparent;
        }
        
        .batch-item-title .source-title:hover {
            border-bottom-color: rgba(255, 255, 255, 0.5);
        }
        
        .batch-item-title .source-title:not([href]) {
            cursor: default;
            text-decoration: none;
            border-bottom: none;
        }

        .batch-item-icon {
            width: 32px;
            height: 32px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        .batch-item-status {
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            backdrop-filter: blur(10px);
        }

        .batch-status {
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 11px;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        .batch-status.Â§ÑÁêÜ‰∏≠ {
            background: rgba(255, 193, 7, 0.9);
            color: #856404;
        }

        .batch-status.ÂÆåÊàê {
            background: rgba(40, 167, 69, 0.9);
            color: white;
        }

        .batch-status.ÈîôËØØ {
            background: rgba(220, 53, 69, 0.9);
            color: white;
        }

        .batch-progress {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.8);
            margin-left: 10px;
        }

        .batch-item-status.success {
            background: rgba(39, 174, 96, 0.9);
        }

        .batch-item-status.error {
            background: rgba(231, 76, 60, 0.9);
        }

        .batch-item-status.processing {
            background: rgba(52, 152, 219, 0.9);
        }

        .batch-item-content {
            padding: 25px;
        }

        .batch-item-tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 20px;
            border-bottom: 2px solid #f0f0f0;
            background: #f8f9fa;
            padding: 0 15px;
            border-radius: 10px 10px 0 0;
        }

        .batch-item-tab {
            padding: 12px 20px;
            background: none;
            border: none;
            color: #6c757d;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            border-radius: 8px 8px 0 0;
            position: relative;
        }

        .batch-item-tab:hover {
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
        }

        .batch-item-tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
            background: white;
        }

        .batch-item-tab-content {
            display: none;
            min-height: 200px;
        }

        .batch-item-tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }
        
        .loading-placeholder {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px 20px;
            color: #6c757d;
            font-size: 14px;
            background: #f8f9fa;
            border-radius: 10px;
            border: 1px dashed #dee2e6;
        }

        .batch-analysis-content {
            line-height: 1.8;
            color: #2c3e50;
        }

        .batch-time-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .batch-time-stat {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 15px;
            border-radius: 12px;
            text-align: center;
            border: 1px solid #dee2e6;
            transition: all 0.3s ease;
        }

        .batch-time-stat:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .batch-time-stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }

        .batch-time-stat-label {
            font-size: 12px;
            color: #6c757d;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        /* ÂÖ≥ÈîÆ‰ø°ÊÅØÊ¶ÇËßàÊ†∑Âºè */
        .key-info-overview {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 25px;
            border: 1px solid #dee2e6;
        }
        
        .key-info-header {
            display: flex;
            align-items: flex-start;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .key-info-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: white;
            flex-shrink: 0;
        }
        
        .key-info-title-area {
            flex: 1;
        }
        
        .key-info-title {
            font-size: 16px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 5px;
            line-height: 1.4;
        }
        
        .key-info-subtitle {
            font-size: 12px;
            color: #6c757d;
            background: rgba(102, 126, 234, 0.1);
            padding: 3px 8px;
            border-radius: 12px;
            display: inline-block;
        }
        
        .key-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
        }
        
        .key-stat-item {
            background: white;
            padding: 12px;
            border-radius: 10px;
            text-align: center;
            border: 1px solid #e1e8ed;
            transition: all 0.3s ease;
        }
        
        .key-stat-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .key-stat-value {
            font-size: 1.4rem;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 4px;
        }
        
        .key-stat-label {
            font-size: 11px;
            color: #6c757d;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .key-stat-highlight {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .key-stat-highlight .key-stat-value {
            color: white;
        }
        
        .key-stat-highlight .key-stat-label {
            color: rgba(255, 255, 255, 0.9);
        }

        .batch-time-stat {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 8px;
            text-align: center;
        }

        .batch-time-stat-value {
            font-size: 1.2rem;
            font-weight: bold;
            color: #667eea;
        }

        .batch-time-stat-label {
            font-size: 11px;
            color: #6c757d;
            margin-top: 3px;
        }

        .batch-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }

        .batch-table th,
        .batch-table td {
            padding: 8px;
            border-bottom: 1px solid #e1e8ed;
        }

        .batch-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #2c3e50;
        }

        .batch-viz-messages {
            max-height: 800px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .batch-viz-message {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 12px;
            border-left: 3px solid #e1e8ed;
            font-size: 13px;
        }

        .batch-viz-message.user {
            border-left-color: #28a745;
            background: linear-gradient(135deg, #f8fff9 0%, #e8f8f5 100%);
        }

        .batch-viz-message.assistant {
            border-left-color: #667eea;
            background: linear-gradient(135deg, #f8f9ff 0%, #e8eaff 100%);
        }

        .batch-viz-message.tool {
            border-left-color: #ffc107;
            background: linear-gradient(135deg, #fffbf0 0%, #fff3cd 100%);
        }

        .batch-viz-message-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .batch-viz-message-type {
            font-size: 10px;
            padding: 2px 8px;
            border-radius: 10px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .batch-viz-message-type.user {
            background: #d5f4e6;
            color: #27ae60;
        }

        .batch-viz-message-type.assistant {
            background: #dae8fc;
            color: #2980b9;
        }

        .batch-viz-message-type.tool {
            background: #fdeaa7;
            color: #d68910;
        }

        .batch-viz-message-time {
            font-size: 10px;
            color: #6c757d;
            font-family: Monaco, 'Courier New', monospace;
        }

        .batch-viz-message-content {
            color: #2c3e50;
            line-height: 1.4;
            font-size: 12px;
        }

        .result-content {
            min-height: 200px;
        }

        .hidden {
            display: none;
        }

        /* ÊâπÈáèÂàÜÊûêÁªìÊûú */
        .batch-results {
            display: grid;
            gap: 20px;
        }

        .conversation-item {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            border-left: 4px solid #667eea;
        }

        .conversation-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .conversation-title {
            font-weight: 600;
            color: #2c3e50;
        }

        .conversation-stats {
            display: flex;
            gap: 15px;
            font-size: 14px;
            color: #5a6c7d;
        }

        .initial-prompt {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            border-left: 4px solid #28a745;
        }

        .prompt-label {
            font-weight: 600;
            color: #28a745;
            margin-bottom: 8px;
        }

        .prompt-text {
            color: #2c3e50;
            line-height: 1.5;
        }

        /* ÊäòÂè†ËæìÂÖ•Âå∫ÂüüÊ†∑Âºè */
        .collapsible-input {
            margin-bottom: 15px;
            border: 2px solid #e1e8ed;
            border-radius: 15px;
            overflow: hidden;
        }
        
        .collapsible-header {
            background: #f8f9fa;
            padding: 15px 20px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }
        
        .collapsible-header:hover {
            background: #e9ecef;
        }
        
        .collapsible-header h3 {
            margin: 0;
            font-size: 16px;
            font-weight: 600;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .collapsible-toggle {
            font-size: 12px;
            color: #6c757d;
            transition: transform 0.3s ease;
        }
        
        .collapsible-toggle.expanded {
            transform: rotate(180deg);
        }
        
        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }
        
        .collapsible-content.expanded {
            max-height: 2000px;
        }
        
        .collapsible-body {
            padding: 20px;
        }
        
        /* Êó∂Èó¥ÂàÜÊûêÁªìÊûú */
        .time-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .summary-item {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            border: 2px solid #e1e8ed;
        }

        .summary-value {
            font-size: 2rem;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }

        .summary-label {
            color: #5a6c7d;
            font-size: 14px;
        }

        .table-container {
            overflow-x: auto;
            border-radius: 10px;
            border: 1px solid #e1e8ed;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #e1e8ed;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #2c3e50;
        }

        tr:hover {
            background: #f8f9fa;
        }

        /* ÂØπËØùÂèØËßÜÂåñÁªìÊûú */
        /* ‰ΩøÁî®È°µÈù¢ÊªöÂä®ÔºåÈÅøÂÖçÂÜÖÈÉ®ÂµåÂ•óÊªöÂä®ÂΩ±ÂìçÊï¥‰ΩìÊªöÂä®‰ΩìÈ™å */
        .conversation-viz { margin: 0; }
        
        /* Ê∂àÊÅØÁ≠õÈÄâÂô® */
        .message-filter {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 1px solid #e1e8ed;
        }
        
        .filter-title {
            font-weight: 600;
            margin-bottom: 10px;
            color: #2c3e50;
        }
        
        .filter-options {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }
        
        .filter-option {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .filter-option input[type="checkbox"] {
            width: auto;
            margin: 0;
        }
        
        .filter-option label {
            font-size: 14px;
            color: #495057;
            cursor: pointer;
        }
        
        /* Metadata Â±ïÂºÄ/Êî∂Ëµ∑ */
        .metadata-toggle {
            background: #6c757d;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            margin-left: 10px;
            transition: background 0.2s ease;
        }
        
        .metadata-toggle:hover {
            background: #5a6268;
        }
        
        .metadata-toggle.expanded {
            background: #28a745;
        }
        
        .message-metadata {
            background: #f8f9fa;
            border: 1px solid #e1e8ed;
            border-radius: 8px;
            padding: 15px;
            margin-top: 10px;
            font-size: 12px;
            color: #6c757d;
            display: none;
        }
        
        .message-metadata.show {
            display: block;
        }
        
        .metadata-item {
            margin: 5px 0;
        }
        
        .metadata-label {
            font-weight: 600;
            color: #495057;
        }
        
        .metadata-value {
            font-family: 'Monaco', 'Courier New', monospace;
            background: #e9ecef;
            padding: 2px 6px;
            border-radius: 4px;
            word-break: break-all;
        }
        
        /* ÈöêËóèÁöÑÊ∂àÊÅØ */
        .message.hidden {
            display: none;
        }
        
        /* ÂçïÊ¨°ÂàÜÊûêPromptÊòæÁ§∫ */
        .single-prompt-display {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .single-prompt-display .prompt-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .single-prompt-display .prompt-header h3 {
            margin: 0;
            font-size: 1.2rem;
            font-weight: 600;
        }
        
        .single-prompt-display .prompt-link {
            color: white;
            text-decoration: none;
            border-bottom: 1px dashed rgba(255, 255, 255, 0.6);
            transition: all 0.3s ease;
            padding-bottom: 1px;
        }
        
        .single-prompt-display .prompt-link:hover {
            border-bottom-color: white;
            color: #f0f8ff;
            text-shadow: 0 0 8px rgba(255, 255, 255, 0.3);
        }
        
        .single-prompt-display .prompt-time {
            background: rgba(255, 255, 255, 0.2);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-family: 'Monaco', 'Courier New', monospace;
        }
        
        .single-prompt-display .prompt-content {
            background: rgba(255, 255, 255, 0.15);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(10px);
            font-size: 14px;
            line-height: 1.6;
            font-weight: 400;
        }

        .viz-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 15px;
        }

        .viz-stats {
            display: flex;
            gap: 20px;
        }

        .viz-stat {
            text-align: center;
        }

        .viz-stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #667eea;
        }

        .viz-stat-label {
            font-size: 12px;
            color: #5a6c7d;
        }

        .message {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            border-left: 4px solid #e1e8ed;
        }

        .message.user {
            border-left-color: #28a745;
            background: linear-gradient(135deg, #f8fff9 0%, #e8f8f5 100%);
        }

        .message.assistant {
            border-left-color: #667eea;
            background: linear-gradient(135deg, #f8f9ff 0%, #e8eaff 100%);
        }

        .message.tool {
            border-left-color: #ffc107;
            background: linear-gradient(135deg, #fffbf0 0%, #fff3cd 100%);
        }

        .message-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .message-type {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .message-type.user {
            background: #d5f4e6;
            color: #27ae60;
        }

        .message-type.assistant {
            background: #dae8fc;
            color: #2980b9;
        }

        .message-type.tool {
            background: #fdeaa7;
            color: #d68910;
        }

        .message-time {
            font-size: 12px;
            color: #5a6c7d;
            font-family: Monaco, 'Courier New', monospace;
        }

        .message-content {
            color: #2c3e50;
            line-height: 1.6;
        }

        .export-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .export-btn:hover {
            background: #218838;
        }

        .timezone-selector {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .timezone-selector label {
            font-size: 14px;
            color: #6c757d;
            font-weight: 500;
        }

        .timezone-selector select,
.control-group.timezone-selector select {
            padding: 8px 16px;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            background: white;
            font-size: 13px;
            font-weight: 500;
            color: #495057;
            transition: all 0.2s ease;
            cursor: pointer;
            min-width: 180px;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%236c757d' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6,9 12,15 18,9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 8px center;
            background-size: 14px;
            padding-right: 30px;
        }

        .timezone-selector select:hover,
.control-group.timezone-selector select:hover {
            border-color: #3498db;
            background: #f8f9fa;
        }

        .timezone-selector select:focus,
.control-group.timezone-selector select:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.1);
        }

        .timezone-selector select option {
            background: white;
            color: #495057;
            padding: 8px;
        }

        @media (max-width: 768px) {
            .results-container {
                grid-template-columns: 1fr;
            }
            
            .input-methods {
                flex-direction: column;
            }
            
            .header h1 {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
  
  <!-- Áªü‰∏ÄËæìÂÖ•Âå∫Âüü -->
        <div class="unified-input">
            <div class="input-header">
                <h2>üì• Êï∞ÊçÆËæìÂÖ•</h2>
                <div class="input-tabs">
                    <button class="input-tab" onclick="switchInputMode('single')">‚ö° ÂçïÊ¨°ÂàÜÊûê</button>
                    <button class="input-tab active" onclick="switchInputMode('batch')">üöÄ ÊâπÈáèÂàÜÊûê</button>
                </div>
            </div>
            
            <!-- ÊâπÈáèÂàÜÊûêÊ®°Âºè -->
            <div id="batch-mode" class="input-mode active">
                <!-- URLËæìÂÖ•ÊäòÂè†Âå∫Âüü -->
                <div class="collapsible-input">
                    <div class="collapsible-header" onclick="toggleCollapsible('url-input')">
                        <h3>üîó ÊâπÈáèURLËæìÂÖ•</h3>
                        <span class="collapsible-toggle expanded" id="url-input-toggle">‚ñº</span>
                    </div>
                    <div class="collapsible-content expanded" id="url-input-content">
                        <div class="collapsible-body">
                            <div class="batch-url-container">
                                <div class="url-inputs-grid">
                                    <!-- ÊâπÈáèÁ≤òË¥¥Âå∫Âüü -->
                                    <div class="batch-paste-section">
                                        <div class="paste-header">
                                            <h4>üìã ÊâπÈáèÁ≤òË¥¥URL</h4>
                                            <button class="parse-btn" onclick="parseBatchUrls()">Ëß£ÊûêURL</button>
                                        </div>
                                        <textarea 
                                            class="batch-paste-input" 
                                            id="batch-paste-input"
                                            placeholder="Á≤òË¥¥Â§ö‰∏™URLÔºåÊØèË°å‰∏Ä‰∏™ÊàñÁî®ÈÄóÂè∑ÂàÜÈöîÔºö&#10;https://your-server.com/share/abc123&#10;https://your-server.com/share/def456&#10;https://your-server.com/share/ghi789"
                                        ></textarea>
                                    </div>
                                    
                                    <!-- ÊâãÂä®Ê∑ªÂä†URLÂå∫Âüü -->
                                    <div class="manual-add-section">
                                        <div class="manual-add-header">
                                            <h4>üîó ÊâãÂä®Ê∑ªÂä†URL</h4>
                                            <button class="add-url-btn" onclick="addUrlInput()">
                                                <span>+</span>
                                                <span>Ê∑ªÂä†URL</span>
                                            </button>
                                        </div>
                                        <div id="url-list" class="url-list">
                                            <div class="url-item">
                                                <div class="url-counter">1</div>
                                                <input type="url" class="batch-url-input" placeholder="Á≤òË¥¥ https://your-server.com/share/... URL">
                                                <button class="remove-btn" onclick="removeUrlInput(this)">√ó</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="paste-hint">
                                    üí° ÊèêÁ§∫ÔºöÂ∑¶‰æßÊîØÊåÅÊâπÈáèÁ≤òË¥¥Â§ö‰∏™URLËá™Âä®Ëß£ÊûêÔºåÂè≥‰æßÊîØÊåÅÊâãÂä®ÈÄê‰∏™Ê∑ªÂä†
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- JSONËæìÂÖ•ÊäòÂè†Âå∫Âüü -->
                <div class="collapsible-input">
                    <div class="collapsible-header" onclick="toggleCollapsible('json-input')">
                        <h3>üìÑ ÊâπÈáèJSONËæìÂÖ•</h3>
                        <span class="collapsible-toggle" id="json-input-toggle">‚ñ∂</span>
                    </div>
                    <div class="collapsible-content" id="json-input-content">
                        <div class="collapsible-body">
                            <textarea class="batch-json-input" id="batch-json-input" placeholder="Á≤òË¥¥Â§ö‰∏™ÂØπËØùÁöÑJSONÊï∞ÊçÆÔºåÊØèË°å‰∏Ä‰∏™ÔºåÊàñÁî®ÈÄóÂè∑ÂàÜÈöî..."></textarea>
                        </div>
                    </div>
                </div>
                
                <div class="analysis-controls">
                    <div class="control-group analysis-type">
                        <label>ÂàÜÊûêÁ±ªÂûã:</label>
                        <div class="checkbox-group">
                            <label class="checkbox-label">
                                <input type="checkbox" id="include-batch-single" checked>
                                <span>ÊâπÈáèÂàÜÊûê</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" id="include-time-single" checked>
                                <span>Êó∂Èó¥ÂàÜÊûê</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" id="include-viz-single" checked>
                                <span>ÂØπËØùÂèØËßÜÂåñ</span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="control-group timezone-selector">
                        <label for="timezone-select-single">Êó∂Âå∫:</label>
                        <select id="timezone-select-single">
                            <option value="UTC">UTC</option>
                            <option value="Asia/Shanghai" selected>UTC+8 (Asia/Shanghai)</option>
                            <option value="America/Los_Angeles">America/Los_Angeles</option>
                            <option value="America/New_York">America/New_York</option>
                            <option value="Europe/London">Europe/London</option>
                        </select>
                    </div>
                    
                    <button class="analyze-btn" onclick="analyzeData()">
                        üöÄ ÂºÄÂßãÊâπÈáèÂàÜÊûê
                    </button>
                </div>
            </div>
            
            <!-- ÂçïÊ¨°ÂàÜÊûêÊ®°Âºè -->
            <div id="single-mode" class="input-mode">
                <div class="single-input-section">
                    <div class="input-methods">
                        <div class="input-method active" id="url-method-single" onclick="switchInputMethod('url')">
                            <h3>üîó URLËæìÂÖ•</h3>
                            <div class="input-controls">
                                <input type="url" class="url-input" id="url-input" placeholder="Á≤òË¥¥ https://your-server.com/share/... URL">
                            </div>
                        </div>
                        
                        <div class="input-method" id="json-method-single" onclick="switchInputMethod('json')">
                            <h3>üìÑ JSONËæìÂÖ•</h3>
                            <div class="input-controls">
                                <textarea class="json-input" id="json-input" placeholder="Á≤òË¥¥ÂØπËØùJSONÊï∞ÊçÆ..."></textarea>
                            </div>
                        </div>
                    </div>
                    
                    <div class="analysis-controls">
                        <div class="control-group timezone-selector">
                            <label for="timezone-select-single">Êó∂Âå∫:</label>
                            <select id="timezone-select-single">
                                <option value="UTC">UTC</option>
                                <option value="Asia/Shanghai" selected>UTC+8 (Asia/Shanghai)</option>
                                <option value="America/Los_Angeles">America/Los_Angeles</option>
                                <option value="America/New_York">America/New_York</option>
                                <option value="Europe/London">Europe/London</option>
                            </select>
                        </div>
                        
                        <button class="analyze-btn" onclick="analyzeData()">
                            ‚ö° ÂºÄÂßãÂàÜÊûê
                        </button>
                    </div>
                </div>
            </div>
            
            <div id="status" class="status-message"></div>
        </div>

        <!-- ÊâπÈáèÂàÜÊûêÁªìÊûúÂå∫Âüü -->
        <div class="batch-results-section hidden" id="batch-results-section">
            <div class="result-content" id="batch-results-content">
                <div class="batch-summary" id="batch-summary">
                    <!-- ÊâπÈáèÂàÜÊûêÁªüËÆ°‰ø°ÊÅØ -->
                </div>
                <div class="batch-items-container" id="batch-items-container">
                    <!-- ÂêÑ‰∏™ÂØπËØùÁöÑÂàÜÊûêÁªìÊûú -->
                </div>
            </div>
        </div>

        <!-- ÂçïÊ¨°ÂàÜÊûêÁªìÊûúÂå∫Âüü -->
        <div class="single-results-section hidden" id="single-results-section">
            <div class="results-container">
                <!-- ÊâπÈáèÂàÜÊûêÁªìÊûú -->
                <div class="result-section hidden" id="batch-results">
                    <div class="result-header">
                        <h2>üìä ÊâπÈáèÂàÜÊûêÁªìÊûú</h2>
                        <button class="export-btn" onclick="exportBatchResults()">ÂØºÂá∫ÁªìÊûú</button>
                    </div>
                    <div class="result-content" id="batch-content">
                        <!-- ÊâπÈáèÂàÜÊûêÁªìÊûúÂ∞ÜÂú®ËøôÈáåÊòæÁ§∫ -->
                    </div>
                </div>

                <!-- Êó∂Èó¥ÂàÜÊûêÁªìÊûú -->
                <div class="result-section hidden" id="time-results">
                    <div class="result-header">
                        <h2>‚è±Ô∏è Êó∂Èó¥ÂàÜÊûêÁªìÊûú</h2>
                        <button class="export-btn" onclick="exportTimeResults()">ÂØºÂá∫CSV</button>
                    </div>
                    <div class="result-content" id="time-content">
                        <!-- Êó∂Èó¥ÂàÜÊûêÁªìÊûúÂ∞ÜÂú®ËøôÈáåÊòæÁ§∫ -->
                    </div>
                </div>
            </div>

            <!-- ÂØπËØùÂèØËßÜÂåñÁªìÊûú -->
            <div class="result-section full-width hidden" id="viz-results">
                <div class="result-header">
                    <h2>üëÅÔ∏è ÂØπËØùÂèØËßÜÂåñ</h2>
                    <div class="timezone-selector">
                        <label for="timezone-select-viz">Êó∂Âå∫: </label>
                        <select id="timezone-select-viz">
                            <option value="UTC">UTC</option>
                            <option value="Asia/Shanghai" selected>UTC+8 (Asia/Shanghai)</option>
                            <option value="America/Los_Angeles">America/Los_Angeles</option>
                            <option value="America/New_York">America/New_York</option>
                            <option value="Europe/London">Europe/London</option>
                        </select>
                    </div>
                </div>
                <div class="result-content" id="viz-content">
                    <!-- ÂØπËØùÂèØËßÜÂåñÁªìÊûúÂ∞ÜÂú®ËøôÈáåÊòæÁ§∫ -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // ÂÖ®Â±ÄÂèòÈáè
        let currentData = null;
        let currentInputMethod = 'url';
        let currentTimezone = 'Asia/Shanghai';
        let currentInputMode = 'single';
        let batchResults = [];
        let isProcessingBatch = false;

        // ÂàáÊç¢ËæìÂÖ•Ê®°ÂºèÔºàÊâπÈáè/ÂçïÊ¨°Ôºâ
        function switchInputMode(mode) {
            const tabs = document.querySelectorAll('.input-tab');
            const modes = document.querySelectorAll('.input-mode');
            const resultsContainer = document.querySelector('.results-container');
            
            // Êõ¥Êñ∞Ê†áÁ≠æÁä∂ÊÄÅ
            tabs.forEach(tab => {
                if (tab.getAttribute('onclick') === `switchInputMode('${mode}')`) {
                    tab.classList.add('active');
                } else {
                    tab.classList.remove('active');
                }
            });
            
            // Êõ¥Êñ∞Ê®°ÂºèÊòæÁ§∫
            modes.forEach(m => {
                if (m.id === `${mode}-mode`) {
                    m.classList.add('active');
                } else {
                    m.classList.remove('active');
                }
            });
            
            // Êõ¥Êñ∞ÁªìÊûúÂÆπÂô®Â∏ÉÂ±Ä
            if (mode === 'single') {
                resultsContainer.classList.add('single-mode');
                // ÈöêËóèÊâπÈáèÂàÜÊûêÁªìÊûú
                document.getElementById('batch-results').classList.add('hidden');
            } else {
                resultsContainer.classList.remove('single-mode');
            }
            
            currentInputMode = mode;
        }

        // ÂàáÊç¢ËæìÂÖ•ÊñπÊ≥ïÔºàURL/JSONÔºâ
        function switchInputMethod(method) {
            currentInputMethod = method;
            
            // Only handle single mode switching (batch mode doesn't have method switching)
            if (currentInputMode === 'single') {
                document.querySelectorAll('#single-mode .input-method').forEach(el => {
                    el.classList.remove('active');
                });
                document.getElementById(`${method}-method-single`).classList.add('active');
            }
        }

        // Ê∑ªÂä†URLËæìÂÖ•Ê°Ü
        function addUrlInput() {
            const urlList = document.getElementById('url-list');
            const currentCount = urlList.children.length + 1;
            const urlItem = document.createElement('div');
            urlItem.className = 'url-item';
            urlItem.innerHTML = `
                <div class="url-counter">${currentCount}</div>
                <input type="url" class="batch-url-input" placeholder="Á≤òË¥¥ https://your-server.com/share/... URL">
                <button class="remove-btn" onclick="removeUrlInput(this)">√ó</button>
            `;
            urlList.appendChild(urlItem);
            
            // Ê∑ªÂä†Âä®ÁîªÊïàÊûú
            urlItem.style.opacity = '0';
            urlItem.style.transform = 'translateY(-10px)';
            setTimeout(() => {
                urlItem.style.transition = 'all 0.3s ease';
                urlItem.style.opacity = '1';
                urlItem.style.transform = 'translateY(0)';
            }, 10);
            
            // Êõ¥Êñ∞ÊâÄÊúâËÆ°Êï∞Âô®
            updateUrlCounters();
        }

        // ÁßªÈô§URLËæìÂÖ•Ê°Ü
        function removeUrlInput(button) {
            const urlItem = button.parentElement;
            urlItem.style.transition = 'all 0.3s ease';
            urlItem.style.opacity = '0';
            urlItem.style.transform = 'translateX(20px)';
            
            setTimeout(() => {
                urlItem.remove();
                updateUrlCounters();
            }, 300);
        }

        // Êõ¥Êñ∞URLËÆ°Êï∞Âô®
        function updateUrlCounters() {
            const urlItems = document.querySelectorAll('.url-item');
            urlItems.forEach((item, index) => {
                const counter = item.querySelector('.url-counter');
                if (counter) {
                    counter.textContent = index + 1;
                }
            });
            
            // Êõ¥Êñ∞URLÊï∞ÈáèÊòæÁ§∫
            updateUrlCountBadge();
        }
        
        // Êõ¥Êñ∞URLÊï∞ÈáèÂæΩÁ´†
        function updateUrlCountBadge() {
            const urlItems = document.querySelectorAll('.url-item');
            const count = urlItems.length;
            
            // Âú®ÊâãÂä®Ê∑ªÂä†Âå∫ÂüüÁöÑÊ†áÈ¢ò‰∏≠ÊòæÁ§∫Êï∞Èáè
            const manualHeader = document.querySelector('.manual-add-header h4');
            if (manualHeader) {
                // ÁßªÈô§ÊóßÁöÑÂæΩÁ´†
                const oldBadge = manualHeader.querySelector('.url-count-badge');
                if (oldBadge) {
                    oldBadge.remove();
                }
                
                // Ê∑ªÂä†Êñ∞ÁöÑÂæΩÁ´†
                if (count > 0) {
                    const badge = document.createElement('span');
                    badge.className = 'url-count-badge';
                    badge.textContent = `${count} ‰∏™URL`;
                    manualHeader.appendChild(badge);
                }
            }
        }
        
        // Ëß£ÊûêÊâπÈáèURL
        function parseBatchUrls() {
            const pasteInput = document.getElementById('batch-paste-input');
            const text = pasteInput.value.trim();
            
            if (!text) {
                showStatus('ËØ∑ÂÖàÁ≤òË¥¥URLÂÜÖÂÆπ', 'error');
                return;
            }
            
            // Ëß£ÊûêURL - ÊîØÊåÅÂ§öÁßçÂàÜÈöîÁ¨¶
            const urls = text
                .split(/[,\n\r\t]+/)
                .map(url => url.trim())
                .filter(url => url.length > 0);
            
            if (urls.length === 0) {
                showStatus('Êú™ÊâæÂà∞ÊúâÊïàÁöÑURL', 'error');
                return;
            }
            
            // È™åËØÅURLÊ†ºÂºè
            const validUrls = [];
            const invalidUrls = [];
            
            urls.forEach(url => {
                try {
                    // Â¶ÇÊûú‰∏çÊòØÂÆåÊï¥ÁöÑURLÔºåÂ∞ùËØïË°•ÂÖ®
                    if (!url.startsWith('http://') && !url.startsWith('https://')) {
                        url = 'https://' + url;
                    }
                    new URL(url);
                    validUrls.push(url);
                } catch (e) {
                    invalidUrls.push(url);
                }
            });
            
            // Ê∏ÖÁ©∫Áé∞ÊúâÁöÑURLÂàóË°®
            const urlList = document.getElementById('url-list');
            urlList.innerHTML = '';
            
            // Ê∑ªÂä†Ëß£ÊûêÂá∫ÁöÑURL
            validUrls.forEach((url, index) => {
                const urlItem = document.createElement('div');
                urlItem.className = 'url-item';
                urlItem.innerHTML = `
                    <div class="url-counter">${index + 1}</div>
                    <input type="url" class="batch-url-input" value="${url}" placeholder="Á≤òË¥¥ https://your-server.com/share/... URL">
                    <button class="remove-btn" onclick="removeUrlInput(this)">√ó</button>
                `;
                urlList.appendChild(urlItem);
            });
            
            // Êõ¥Êñ∞ËÆ°Êï∞Âô®
            updateUrlCounters();
            
            // ÊòæÁ§∫Ëß£ÊûêÁªìÊûú
            let message = `ÊàêÂäüËß£Êûê ${validUrls.length} ‰∏™URL`;
            if (invalidUrls.length > 0) {
                message += `Ôºå${invalidUrls.length} ‰∏™Êó†ÊïàURLÂ∑≤ÂøΩÁï•`;
            }
            showStatus(message, 'success');
            
            // Ê∏ÖÁ©∫Á≤òË¥¥Âå∫Âüü
            pasteInput.value = '';
            
            // ÊòæÁ§∫ÊàêÂäüÊèêÁ§∫
            if (validUrls.length > 0) {
                setTimeout(() => {
                    showStatus(`Â∑≤Ê∑ªÂä† ${validUrls.length} ‰∏™URLÂà∞ÂàÜÊûêÂàóË°®`, 'success');
                }, 1000);
            }
        }

        // Ëé∑ÂèñÊâπÈáèURLËæìÂÖ•
        function getBatchUrls() {
            const urlInputs = document.querySelectorAll('.batch-url-input');
            const urls = [];
            urlInputs.forEach(input => {
                const url = input.value.trim();
                if (url) {
                    urls.push(url);
                }
            });
            return urls;
        }

        // Ëé∑ÂèñÊâπÈáèJSONËæìÂÖ•
        function getBatchJsonData() {
            const jsonText = document.getElementById('batch-json-input').value.trim();
            if (!jsonText) return [];
            
            // Â∞ùËØïÊåâË°åÂàÜÂâ≤
            const lines = jsonText.split('\n').filter(line => line.trim());
            const jsonData = [];
            
            for (const line of lines) {
                try {
                    const data = JSON.parse(line.trim());
                    if (data && Array.isArray(data.data)) {
                        jsonData.push(data);
                    }
                } catch (e) {
                    // Â¶ÇÊûú‰∏çÊòØJSONÔºåÂèØËÉΩÊòØÈÄóÂè∑ÂàÜÈöîÁöÑJSONÂ≠óÁ¨¶‰∏≤
                    try {
                        const allData = JSON.parse('[' + jsonText + ']');
                        if (Array.isArray(allData)) {
                            return allData.filter(item => item && Array.isArray(item.data));
                        }
                    } catch (e2) {
                        console.warn('Êó†Ê≥ïËß£ÊûêJSONË°å:', line);
                    }
                }
            }
            
            return jsonData;
        }

        // ÊâπÈáèÂàÜÊûê‰∏ªË¶ÅÂáΩÊï∞
        async function analyzeBatchData() {
            if (isProcessingBatch) {
                showStatus('Ê≠£Âú®Â§ÑÁêÜÊâπÈáèÂàÜÊûêÔºåËØ∑Á®çÂÄô...', 'loading');
                return;
            }

            try {
                isProcessingBatch = true;
                batchResults = [];
                
                // Ëé∑ÂèñÈÄâ‰∏≠ÁöÑÂàÜÊûêÁ±ªÂûã
                const batchCheckbox = document.getElementById('include-batch-single');
                const timeCheckbox = document.getElementById('include-time-single');
                const vizCheckbox = document.getElementById('include-viz-single');
                
                console.log('Â§çÈÄâÊ°ÜÂÖÉÁ¥†Êü•ÊâæÁªìÊûú:', {
                    batchCheckbox: !!batchCheckbox,
                    timeCheckbox: !!timeCheckbox,
                    vizCheckbox: !!vizCheckbox
                });
                
                const includeBatch = batchCheckbox ? batchCheckbox.checked : false;
                const includeTime = timeCheckbox ? timeCheckbox.checked : false;
                const includeViz = vizCheckbox ? vizCheckbox.checked : false;
                
                console.log('ÂàÜÊûêÁ±ªÂûãÈÄâÊã©Áä∂ÊÄÅ:', { includeBatch, includeTime, includeViz });
                
                if (!includeBatch && !includeTime && !includeViz) {
                    showStatus('ËØ∑Ëá≥Â∞ëÈÄâÊã©‰∏ÄÁßçÂàÜÊûêÁ±ªÂûã', 'error');
                    return;
                }

                // Ëé∑ÂèñÊï∞ÊçÆÊ∫ê
                const urls = getBatchUrls();
                const jsonData = getBatchJsonData();
                
                if (urls.length === 0 && jsonData.length === 0) {
                    showStatus('ËØ∑ËæìÂÖ•Ëá≥Â∞ë‰∏Ä‰∏™URLÊàñJSONÊï∞ÊçÆ', 'error');
                    return;
                }

                // È™åËØÅURLÊ†ºÂºè
                for (const url of urls) {
                    try {
                        new URL(url);
                    } catch (e) {
                        showStatus(`Êó†ÊïàÁöÑURLÊ†ºÂºè: ${url}`, 'error');
                        return;
                    }
                }

                // ÊòæÁ§∫ÊâπÈáèÂàÜÊûêÁªìÊûúÂå∫Âüü
                document.getElementById('batch-results-section').classList.remove('hidden');
                document.getElementById('single-results-section').classList.add('hidden');
                
                // Ê∏ÖÁ©∫‰πãÂâçÁöÑÁªìÊûú
                document.getElementById('batch-items-container').innerHTML = '';

                // ÂêàÂπ∂ÊâÄÊúâÊï∞ÊçÆÊ∫ê
                const allData = [];
                urls.forEach(url => allData.push({ type: 'url', data: url }));
                jsonData.forEach(data => allData.push({ type: 'json', data: data }));

                // ÊòæÁ§∫ÊâπÈáèÂàÜÊûêËøõÂ∫¶
                showBatchProgress();
                
                // Â§ÑÁêÜÊØè‰∏™Êï∞ÊçÆÊ∫ê
                let successCount = 0;
                let errorCount = 0;
                
                for (let i = 0; i < allData.length; i++) {
                    const item = allData[i];
                    try {
                        await processBatchItem(item, i + 1, allData.length, includeBatch, includeTime, includeViz);
                        successCount++;
                    } catch (itemError) {
                        console.error(`Â§ÑÁêÜÊï∞ÊçÆÊ∫ê ${i + 1} Â§±Ë¥•:`, itemError);
                        errorCount++;
                        // Êõ¥Êñ∞ËØ•È°πÁõÆÁöÑÁä∂ÊÄÅ‰∏∫ÈîôËØØ
                        updateBatchItemStatus(i + 1, 'ÈîôËØØ', itemError.message);
                    }
                    
                    // Êõ¥Êñ∞ËøõÂ∫¶
                    updateBatchProgress(i + 1, allData.length, successCount, errorCount);
                }

                // ÊòæÁ§∫ÊâπÈáèÊ±áÊÄª
                showBatchSummary();
                
                if (errorCount === 0) {
                    showStatus(`ÊâπÈáèÂàÜÊûêÂÆåÊàêÔºÅÊàêÂäüÂ§ÑÁêÜ‰∫Ü ${allData.length} ‰∏™Êï∞ÊçÆÊ∫ê`, 'success');
                } else {
                    showStatus(`ÊâπÈáèÂàÜÊûêÂÆåÊàêÔºÅÂ§ÑÁêÜ‰∫Ü ${allData.length} ‰∏™Êï∞ÊçÆÊ∫êÔºåÊàêÂäü ${successCount} ‰∏™ÔºåÂ§±Ë¥• ${errorCount} ‰∏™`, 'warning');
                }
                
                // ‰øÆÂ§çÈ°µÈù¢ÊªöÂä®ÈóÆÈ¢ò
                setTimeout(() => {
                    document.body.style.overflow = '';
                    document.documentElement.style.overflow = '';
                    document.body.style.position = '';
                    document.documentElement.style.position = '';
                    document.body.style.height = '';
                    document.documentElement.style.height = '';
                    
                    // Á°Æ‰øùÈ°µÈù¢ÂèØ‰ª•Ê≠£Â∏∏ÊªöÂä®
                    const pageHeight = Math.max(
                        document.body.scrollHeight,
                        document.body.offsetHeight,
                        document.documentElement.clientHeight,
                        document.documentElement.scrollHeight,
                        document.documentElement.offsetHeight
                    );
                    
                    if (pageHeight > window.innerHeight) {
                        document.body.style.overflowY = 'auto';
                        document.documentElement.style.overflowY = 'auto';
                    }
                    
                    console.log('ÊâπÈáèÂàÜÊûêÈ°µÈù¢ÊªöÂä®‰øÆÂ§çÂÆåÊàêÔºåÈ°µÈù¢È´òÂ∫¶:', pageHeight, 'Á™óÂè£È´òÂ∫¶:', window.innerHeight);
                }, 100);

            } catch (error) {
                console.error('ÊâπÈáèÂàÜÊûêÂ§±Ë¥•:', error);
                showStatus(`ÊâπÈáèÂàÜÊûêÂ§±Ë¥•: ${error.message}`, 'error');
            } finally {
                isProcessingBatch = false;
            }
        }

        // Â§ÑÁêÜÂçï‰∏™ÊâπÈáèÈ°πÁõÆ
        async function processBatchItem(item, index, total, includeBatch, includeTime, includeViz) {
            const resultId = `batch-item-${index}`;
            let result = {
                id: resultId,
                index: index,
                source: item.type === 'url' ? item.data : 'JSONÊï∞ÊçÆ',
                status: 'processing',
                data: null,
                error: null,
                analysis: {}
            };

            // ÂàõÂª∫ÁªìÊûúÈ°π
            createBatchResultItem(result);
            updateBatchItemStatus(result.index, 'Â§ÑÁêÜ‰∏≠');

            try {
                console.log('Â§ÑÁêÜÊâπÈáèÈ°πÁõÆ:', item);
                
                // Ëé∑ÂèñÊï∞ÊçÆ
                let data;
                if (item.type === 'url') {
                    console.log('‰ªéURLËé∑ÂèñÊï∞ÊçÆ:', item.data);
                    data = await fetchSingleUrl(item.data);
                } else {
                    console.log('‰ΩøÁî®JSONÊï∞ÊçÆ:', item.data);
                    data = item.data;
                }

                console.log('Ëé∑ÂèñÂà∞ÁöÑÊï∞ÊçÆ:', data);
                
                // È™åËØÅÊï∞ÊçÆ
                if (!data || !Array.isArray(data.data)) {
                    console.error('Êï∞ÊçÆÊ†ºÂºèÈîôËØØÔºåÊúüÊúõ { data: [...] }ÔºåÂÆûÈôÖ:', data);
                    throw new Error('Êï∞ÊçÆÊ†ºÂºèÈîôËØØÔºöÊúüÊúõ { data: [...] }');
                }

                result.data = data;
                result.status = 'success';

                // ÊâßË°åÂàÜÊûê
                if (includeBatch) {
                    result.analysis.batch = analyzeBatchContent(data);
                }
                if (includeTime) {
                    result.analysis.time = analyzeTimeContent(data);
                }
                if (includeViz) {
                    result.analysis.viz = analyzeVizContent(data);
                }

                batchResults.push(result);
                updateBatchItemContent(result);
                updateBatchItemStatus(result.index, 'ÂÆåÊàê');

            } catch (error) {
                result.status = 'error';
                result.error = error.message;
                batchResults.push(result);
                updateBatchItemStatus(result.index, 'ÈîôËØØ', error.message);
            }
        }

        // ‰ªéURL‰∏≠ÊèêÂèñÊúçÂä°Âô®Âú∞ÂùÄ
        function extractServerUrl(url) {
            try {
                const urlObj = new URL(url);
                return `${urlObj.protocol}//${urlObj.hostname}`;
            } catch (error) {
                console.error('Êó†Ê≥ïËß£ÊûêURL:', url, error);
                return 'https://staging.societas.ms'; // ÈªòËÆ§ÂÄº
            }
        }

        // Ëé∑ÂèñÂçï‰∏™URLÊï∞ÊçÆ
        async function fetchSingleUrl(url) {
            console.log('fetchSingleUrl called with:', url);
            
            if (url.includes('/share/')) {
                const threadId = url.split('/share/')[1];
                if (threadId) {
                    const serverUrl = extractServerUrl(url);
                    const proxyUrl = `https://corsproxy.io/?${serverUrl}/api/message/list`;
                    console.log('‰ΩøÁî®Âä®ÊÄÅÊúçÂä°Âô®Âú∞ÂùÄ:', serverUrl);
                    console.log('ÊèêÂèñÁöÑthreadId:', threadId);
                    const response = await fetch(proxyUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        },
                        body: JSON.stringify({ thread_id: threadId })
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }

                    const data = await response.json();
                    console.log('APIËøîÂõûÊï∞ÊçÆÁªìÊûÑ:', data);
                    if (!data || !Array.isArray(data.data)) {
                        throw new Error('Êï∞ÊçÆÊ†ºÂºèÈîôËØØ');
                    }
                    return data;
                }
            }

            console.log('Áõ¥Êé•Ëé∑ÂèñURLÊï∞ÊçÆ:', url);
            const response = await fetch(url);
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }
            const data = await response.json();
            console.log('Áõ¥Êé•Ëé∑ÂèñÁöÑÊï∞ÊçÆÁªìÊûÑ:', data);
            return data;
        }

        // ÂàõÂª∫ÊâπÈáèÁªìÊûúÈ°π
        function createBatchResultItem(result) {
            const container = document.getElementById('batch-items-container');
            const sourceIcon = result.source.includes('http') ? 'üîó' : 'üìÑ';
            const itemHtml = `
                <div class="batch-item" id="${result.id}">
                    <div class="batch-item-header">
                        <span class="batch-item-title">
                            <span class="batch-item-icon">${sourceIcon}</span>
                            <a href="#" class="source-title" data-url="${result.source}" target="_blank" rel="noopener noreferrer">Êï∞ÊçÆÊ∫ê ${result.index}</a>
                        </span>
                        <span class="batch-item-status batch-status processing" id="batch-status-${result.index}">Â§ÑÁêÜ‰∏≠</span>
                        <span class="batch-progress" id="batch-progress-${result.index}"></span>
                    </div>
                    <div class="batch-item-content">
                        <!-- ÂÖ≥ÈîÆ‰ø°ÊÅØÊ¶ÇËßà -->
                        <div class="key-info-overview" id="${result.id}-key-info">
                            <div class="loading-placeholder">
                                <div class="loading-spinner"></div>
                                Ê≠£Âú®ÊèêÂèñÂÖ≥ÈîÆ‰ø°ÊÅØ...
                            </div>
                        </div>
                        
                        <div class="batch-item-tabs">
                            <button class="batch-item-tab active" onclick="switchBatchItemTab('${result.id}', 'batch')">
                                üìä ÊâπÈáèÂàÜÊûê
                            </button>
                            <button class="batch-item-tab" onclick="switchBatchItemTab('${result.id}', 'time')">
                                ‚è±Ô∏è Êó∂Èó¥ÂàÜÊûê
                            </button>
                            <button class="batch-item-tab" onclick="switchBatchItemTab('${result.id}', 'viz')">
                                üí¨ ÂØπËØùÂèØËßÜÂåñ
                            </button>
                        </div>
                        <div class="batch-item-tab-content active" id="${result.id}-batch-content">
                            <div class="loading-placeholder">
                                <div class="loading-spinner"></div>
                                Ê≠£Âú®ÂàÜÊûêÊâπÈáèÂÜÖÂÆπ...
                            </div>
                        </div>
                        <div class="batch-item-tab-content" id="${result.id}-time-content">
                            <div class="loading-placeholder">
                                <div class="loading-spinner"></div>
                                Ê≠£Âú®ÂàÜÊûêÊó∂Èó¥Êï∞ÊçÆ...
                            </div>
                        </div>
                        <div class="batch-item-tab-content" id="${result.id}-viz-content">
                            <div class="loading-placeholder">
                                <div class="loading-spinner"></div>
                                Ê≠£Âú®ÁîüÊàêÂØπËØùÂèØËßÜÂåñ...
                            </div>
                        </div>
                    </div>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', itemHtml);
        }

  
        // Êõ¥Êñ∞ÊâπÈáèÈ°πÂÜÖÂÆπ
        function updateBatchItemContent(result) {
            // Êõ¥Êñ∞ÂÖ≥ÈîÆ‰ø°ÊÅØÊ¶ÇËßà
            updateKeyInfoOverview(result);
            
            // Êõ¥Êñ∞ÂêÑ‰∏™Ê†áÁ≠æÈ°µÂÜÖÂÆπ
            if (result.analysis.batch) {
                document.getElementById(`${result.id}-batch-content`).innerHTML = result.analysis.batch;
            }
            if (result.analysis.time) {
                document.getElementById(`${result.id}-time-content`).innerHTML = result.analysis.time;
            }
            if (result.analysis.viz) {
                document.getElementById(`${result.id}-viz-content`).innerHTML = result.analysis.viz;
            }
        }
        
        // Êõ¥Êñ∞ÂÖ≥ÈîÆ‰ø°ÊÅØÊ¶ÇËßà
        function updateKeyInfoOverview(result) {
            const keyInfoElement = document.getElementById(`${result.id}-key-info`);
            if (!keyInfoElement || !result.data || !Array.isArray(result.data.data)) {
                return;
            }
            
            const messages = result.data.data;
            const userMessages = messages.filter(m => m.type === 'user');
            const assistantMessages = messages.filter(m => m.type === 'assistant');
            const toolMessages = messages.filter(m => m.type === 'tool');
            
            // ÊèêÂèñÁî®Êà∑Prompt
            let userPrompt = 'Êó†Áî®Êà∑Ê∂àÊÅØ';
            if (userMessages.length > 0) {
                const firstUserMessage = userMessages[0];
                console.log('Áî®Êà∑Ê∂àÊÅØÁªìÊûÑ:', firstUserMessage);
                console.log('Áî®Êà∑Ê∂àÊÅØcontent:', firstUserMessage.content);
                console.log('Áî®Êà∑Ê∂àÊÅØcontentÁ±ªÂûã:', typeof firstUserMessage.content);
                
                userPrompt = extractCleanPrompt(firstUserMessage.content || '');
                console.log('ÊèêÂèñÂêéÁöÑPrompt:', userPrompt);
                
                // ÈôêÂà∂ÈïøÂ∫¶
                if (userPrompt.length > 100) {
                    userPrompt = userPrompt.substring(0, 100) + '...';
                }
            }
            
            // Êõ¥Êñ∞Ê†áÈ¢ò‰∏∫PromptÂπ∂ËÆæÁΩÆ‰∏∫Ë∂ÖÈìæÊé•
            const titleElement = document.querySelector(`#${result.id} .source-title`);
            if (titleElement) {
                titleElement.textContent = userPrompt;
                // Â¶ÇÊûúÊòØURLÁ±ªÂûãÔºåËÆæÁΩÆhrefÂ±ûÊÄß
                if (result.source && result.source.includes('http')) {
                    titleElement.href = result.source;
                } else {
                    // Â¶ÇÊûú‰∏çÊòØURLÔºåÁßªÈô§hrefÂ±ûÊÄß‰ΩøÂÖ∂‰∏çÂèØÁÇπÂáª
                    titleElement.removeAttribute('href');
                    titleElement.style.cursor = 'default';
                    titleElement.style.textDecoration = 'none';
                }
            }
            
            // ËÆ°ÁÆóÊó∂Èó¥ÁªüËÆ°
            const parsedMessages = messages.map(msg => ({
                ...msg,
                parsedDate: parseIso(msg.created_at)
            })).sort((a, b) => a.parsedDate - b.parsedDate);
            
            const runs = computeRuns(parsedMessages);
            const cycles = computeCycles(parsedMessages);
            const runSum = summarizeWindows(runs);
            const cycleSum = summarizeWindows(cycles);
            
            // ÁîüÊàêÂÖ≥ÈîÆ‰ø°ÊÅØHTML
            const keyInfoHtml = `
                <div class="key-info-header">
                    <div class="key-info-icon">üí¨</div>
                    <div class="key-info-title-area">
                        <div class="key-info-title">${userPrompt}</div>
                    </div>
                </div>
                
                <div class="key-stats-grid">
                    <div class="key-stat-item key-stat-highlight">
                        <div class="key-stat-value">${messages.length}</div>
                        <div class="key-stat-label">ÊÄªÊ∂àÊÅØÊï∞</div>
                    </div>
                    <div class="key-stat-item">
                        <div class="key-stat-value">${userMessages.length}</div>
                        <div class="key-stat-label">Áî®Êà∑Ê∂àÊÅØ</div>
                    </div>
                    <div class="key-stat-item">
                        <div class="key-stat-value">${assistantMessages.length}</div>
                        <div class="key-stat-label">Âä©ÊâãÊ∂àÊÅØ</div>
                    </div>
                    <div class="key-stat-item key-stat-highlight">
                        <div class="key-stat-value">${cycleSum.total.toFixed(1)}s</div>
                        <div class="key-stat-label">Ê¥ªË∑ÉÂë®ÊúüÊÄªÊó∂Èó¥</div>
                    </div>
                    <div class="key-stat-item">
                        <div class="key-stat-value">${runSum.total.toFixed(1)}s</div>
                        <div class="key-stat-label">LLMËøêË°åÊó∂Èó¥</div>
                    </div>
                    <div class="key-stat-item">
                        <div class="key-stat-value">${toolMessages.length}</div>
                        <div class="key-stat-label">Â∑•ÂÖ∑Ê∂àÊÅØ</div>
                    </div>
                </div>
            `;
            
            keyInfoElement.innerHTML = keyInfoHtml;
        }

        // ÂàáÊç¢ÊâπÈáèÈ°πÊ†áÁ≠æÈ°µ
        function switchBatchItemTab(itemId, tab) {
            const item = document.getElementById(itemId);
            if (!item) return;

            // ÂàáÊç¢Ê†áÁ≠æÈ°µÁä∂ÊÄÅ
            item.querySelectorAll('.batch-item-tab').forEach(t => t.classList.remove('active'));
            item.querySelectorAll('.batch-item-tab-content').forEach(c => c.classList.remove('active'));
            
            item.querySelector(`[onclick="switchBatchItemTab('${itemId}', '${tab}')"]`).classList.add('active');
            document.getElementById(`${itemId}-${tab}-content`).classList.add('active');
        }

        // ÊòæÁ§∫ÊâπÈáèËøõÂ∫¶
        function showBatchProgress() {
            const summaryHtml = `
                <div class="summary-stats">
                    <div class="summary-stat">
                        <div class="summary-stat-value" id="batch-total">0</div>
                        <div class="summary-stat-label">ÊÄªÊï∞ÊçÆÊ∫ê</div>
                    </div>
                    <div class="summary-stat">
                        <div class="summary-stat-value" id="batch-completed">0</div>
                        <div class="summary-stat-label">Â∑≤ÂÆåÊàê</div>
                    </div>
                    <div class="summary-stat">
                        <div class="summary-stat-value" id="batch-success">0</div>
                        <div class="summary-stat-label">ÊàêÂäü</div>
                    </div>
                    <div class="summary-stat">
                        <div class="summary-stat-value" id="batch-error">0</div>
                        <div class="summary-stat-label">Â§±Ë¥•</div>
                    </div>
                </div>
            `;
            document.getElementById('batch-summary').innerHTML = summaryHtml;
        }

        // ÊòæÁ§∫ÊâπÈáèÊ±áÊÄª
        function showBatchSummary() {
            const total = batchResults.length;
            const success = batchResults.filter(r => r.status === 'success').length;
            const error = batchResults.filter(r => r.status === 'error').length;

            document.getElementById('batch-total').textContent = total;
            document.getElementById('batch-completed').textContent = total;
            document.getElementById('batch-success').textContent = success;
            document.getElementById('batch-error').textContent = error;
        }
        
        // Êõ¥Êñ∞ÊâπÈáèËøõÂ∫¶
        function updateBatchProgress(current, total, success, error) {
            document.getElementById('batch-total').textContent = total;
            document.getElementById('batch-completed').textContent = current;
            document.getElementById('batch-success').textContent = success;
            document.getElementById('batch-error').textContent = error;
        }

        // ÂàÜÊûêÊâπÈáèÂÜÖÂÆπ
        function analyzeBatchContent(data) {
            const messages = data.data;
            const userMessages = messages.filter(m => m.type === 'user');
            
            let html = '<div class="batch-analysis-content">';
            
            userMessages.forEach((msg, index) => {
                const content = msg.content || '';
                const cleanContent = extractCleanPrompt(content);
                
                html += `
                    <div class="initial-prompt">
                        <div class="prompt-label">üí¨ Áî®Êà∑ÂàùÂßãÊèêÁ§∫ ${index + 1}</div>
                        <div class="prompt-text">${cleanContent}</div>
                    </div>
                `;
            });
            
            html += '</div>';
            return html;
        }

        // ÂàÜÊûêÊó∂Èó¥ÂÜÖÂÆπ
        function analyzeTimeContent(data) {
            const messages = data.data.map(msg => ({
                ...msg,
                parsedDate: parseIso(msg.created_at)
            })).sort((a, b) => a.parsedDate - b.parsedDate);

            const runs = computeRuns(messages);
            const cycles = computeCycles(messages);
            const runSum = summarizeWindows(runs);
            const cycleSum = summarizeWindows(cycles);

            let html = `
                <div class="batch-time-summary">
                    <div class="batch-time-stat">
                        <div class="batch-time-stat-value">${messages.length}</div>
                        <div class="batch-time-stat-label">ÊÄªÊ∂àÊÅØÊï∞</div>
                    </div>
                    <div class="batch-time-stat">
                        <div class="batch-time-stat-value">${cycleSum.total.toFixed(3)}s</div>
                        <div class="batch-time-stat-label">Ê¥ªË∑ÉÂë®ÊúüÊÄªÊó∂Èó¥</div>
                    </div>
                    <div class="batch-time-stat">
                        <div class="batch-time-stat-value">${runSum.total.toFixed(3)}s</div>
                        <div class="batch-time-stat-label">LLMËøêË°åÊó∂Èó¥</div>
                    </div>
                </div>
            `;

            if (runs.length > 0) {
                html += `
                    <table class="batch-table">
                        <thead>
                            <tr>
                                <th>ËøêË°åID</th>
                                <th>ÊåÅÁª≠Êó∂Èó¥(Áßí)</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                runs.forEach(run => {
                    html += `
                        <tr>
                            <td>${run.run_id || '-'}</td>
                            <td>${run.duration_seconds.toFixed(3)}</td>
                        </tr>
                    `;
                });
                
                html += `
                        </tbody>
                    </table>
                `;
            }

            return html;
        }

        // ÂàÜÊûêÂèØËßÜÂåñÂÜÖÂÆπ
        function analyzeVizContent(data) {
            const messages = data.data.map(msg => ({
                ...msg,
                parsedDate: parseIso(msg.created_at)
            })).sort((a, b) => a.parsedDate - b.parsedDate);

            let html = '<div class="batch-viz-messages">';
            
            // Âè™ÊòæÁ§∫Ââç10Êù°Ê∂àÊÅØ‰ª•ÈÅøÂÖçËøáÈïø
            const displayMessages = messages.slice(0, 10);
            
            displayMessages.forEach(msg => {
                const content = msg.content || '';
                const cleanContent = extractCleanPrompt(content);
                
                html += `
                    <div class="batch-viz-message ${msg.type}">
                        <div class="batch-viz-message-header">
                            <span class="batch-viz-message-type ${msg.type}">${getTypeLabel(msg.type)}</span>
                            <span class="batch-viz-message-time">${formatDate(msg.parsedDate, currentTimezone)}</span>
                        </div>
                        <div class="batch-viz-message-content">
                            ${cleanContent.length > 100 ? cleanContent.substring(0, 100) + '...' : cleanContent}
                        </div>
                    </div>
                `;
            });
            
            if (messages.length > 10) {
                html += `<div style="text-align: center; color: #6c757d; font-size: 12px;">ËøòÊúâ ${messages.length - 10} Êù°Ê∂àÊÅØ...</div>`;
            }
            
            html += '</div>';
            return html;
        }

        // Ê∏ÖÁ©∫ÊâπÈáèÁªìÊûú
        function clearBatchResults() {
            batchResults = [];
            document.getElementById('batch-items-container').innerHTML = '';
            document.getElementById('batch-summary').innerHTML = '';
            document.getElementById('batch-results-section').classList.add('hidden');
            showStatus('ÊâπÈáèÁªìÊûúÂ∑≤Ê∏ÖÁ©∫', 'success');
        }

        // ÂØºÂá∫ÊâÄÊúâÊâπÈáèÁªìÊûú
        function exportAllBatchResults() {
            if (batchResults.length === 0) {
                showStatus('Ê≤°ÊúâÂèØÂØºÂá∫ÁöÑÁªìÊûú', 'error');
                return;
            }

            let csv = 'Êï∞ÊçÆÊ∫ê,Áä∂ÊÄÅ,Ê∂àÊÅØÊï∞,Áî®Êà∑Ê∂àÊÅØÊï∞,Âä©ÊâãÊ∂àÊÅØÊï∞,Â∑•ÂÖ∑Ê∂àÊÅØÊï∞,Ê¥ªË∑ÉÂë®ÊúüÊÄªÊó∂Èó¥,LLMËøêË°åÊÄªÊó∂Èó¥,Ê¥ªË∑ÉÂë®ÊúüÊï∞\n';
            
            batchResults.forEach(result => {
                if (result.status === 'success' && result.data) {
                    const messages = result.data.data;
                    const userMessages = messages.filter(m => m.type === 'user');
                    const assistantMessages = messages.filter(m => m.type === 'assistant');
                    const toolMessages = messages.filter(m => m.type === 'tool');
                    
                    // ËÆ°ÁÆóÊó∂Èó¥ÁªüËÆ°
                    const parsedMessages = messages.map(msg => ({
                        ...msg,
                        parsedDate: parseIso(msg.created_at)
                    })).sort((a, b) => a.parsedDate - b.parsedDate);
                    
                    const runs = computeRuns(parsedMessages);
                    const cycles = computeCycles(parsedMessages);
                    const runSum = summarizeWindows(runs);
                    const cycleSum = summarizeWindows(cycles);
                    
                    csv += `"${result.source}",ÊàêÂäü,${messages.length},${userMessages.length},${assistantMessages.length},${toolMessages.length},${cycleSum.total.toFixed(3)}s,${runSum.total.toFixed(3)}s,${cycles.length}\n`;
                } else {
                    csv += `"${result.source}",Â§±Ë¥•,0,0,0,0,0s,0\n`;
                }
            });
            
            download('batch-analysis-results.csv', csv);
            showStatus('ÊâπÈáèÁªìÊûúÂ∑≤ÂØºÂá∫', 'success');
        }

        // ÊòæÁ§∫Áä∂ÊÄÅÊ∂àÊÅØ
        function showStatus(message, type) {
            const statusEl = document.getElementById('status');
            statusEl.textContent = message;
            statusEl.className = `status-message ${type}`;
        }

        // Êõ¥Êñ∞ÊâπÈáèÈ°πÁõÆÁä∂ÊÄÅ
        function updateBatchItemStatus(index, status, message = '') {
            const statusEl = document.getElementById(`batch-status-${index}`);
            if (statusEl) {
                statusEl.textContent = status;
                statusEl.className = `batch-item-status batch-status ${status.toLowerCase().replace(' ', '-')}`;
            }
            
            const progressEl = document.getElementById(`batch-progress-${index}`);
            if (progressEl) {
                progressEl.textContent = message;
            }
        }

        // Ëß£ÊûêISOÊó∂Èó¥
        function parseIso(ts) {
            ts = ts.replace('Z', '+00:00');
            const tIndex = ts.indexOf('T');
            const posPlus = ts.lastIndexOf('+');
            const posMinus = ts.lastIndexOf('-');
            const tzPos = Math.max(posPlus, posMinus);
            const hasTz = tzPos !== -1 && tzPos > tIndex;
            const main = hasTz ? ts.slice(0, tzPos) : ts;
            const tz = hasTz ? ts.slice(tzPos) : '';
            const dot = main.indexOf('.');
            let norm;
            if (dot !== -1) {
                const secs = main.slice(0, dot);
                let frac = main.slice(dot + 1);
                frac = (frac + '000000').slice(0, 6);
                norm = `${secs}.${frac}${tz}`;
            } else {
                norm = `${main}${tz}`;
            }
            return new Date(norm);
        }

        // Ê†ºÂºèÂåñÊó•Êúü
        function formatDate(date, timezone) {
            if (!date) return '-';
            try {
                return new Intl.DateTimeFormat('zh-CN', {
                    timeZone: timezone,
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: false
                }).format(date);
            } catch (e) {
                return date.toISOString();
            }
        }

        // ÂÆâÂÖ®Ëß£ÊûêJSON
        function safeJsonParse(str) {
            try {
                return JSON.parse(str);
            } catch (e) {
                return null;
            }
        }

        // Ëé∑ÂèñÊï∞ÊçÆ
        async function fetchData() {
            const url = document.getElementById('url-input').value.trim();
            if (!url) {
                throw new Error('ËØ∑ËæìÂÖ•URL');
            }

            showStatus('Ê≠£Âú®Ëé∑ÂèñÊï∞ÊçÆ...', 'loading');

            try {
                // Â¶ÇÊûúÊòØÂàÜ‰∫´URLÔºåÂ∞ùËØïÊèêÂèñthread ID
                if (url.includes('/share/')) {
                    const threadId = url.split('/share/')[1];
                    if (threadId) {
                        const serverUrl = extractServerUrl(url);
                        // ‰ΩøÁî®‰ª£ÁêÜÊúçÂä°
                        const proxyUrl = `https://corsproxy.io/?${serverUrl}/api/message/list`;
                        console.log('‰ΩøÁî®Âä®ÊÄÅÊúçÂä°Âô®Âú∞ÂùÄ:', serverUrl);
                        const response = await fetch(proxyUrl, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Accept': 'application/json'
                            },
                            body: JSON.stringify({ thread_id: threadId })
                        });

                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}`);
                        }

                        const data = await response.json();
                        if (!data || !Array.isArray(data.data)) {
                            throw new Error('Êï∞ÊçÆÊ†ºÂºèÈîôËØØ');
                        }

                        showStatus('Êï∞ÊçÆËé∑ÂèñÊàêÂäüÔºÅ', 'success');
                        return data;
                    }
                }

                // Áõ¥Êé•Ëé∑ÂèñÂÖ∂‰ªñURL
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();
                showStatus('Êï∞ÊçÆËé∑ÂèñÊàêÂäüÔºÅ', 'success');
                return data;

            } catch (error) {
                showStatus(`Ëé∑ÂèñÊï∞ÊçÆÂ§±Ë¥•: ${error.message}`, 'error');
                throw error;
            }
        }

        // ËÆ°ÁÆóLLMËøêË°åÊó∂Èó¥
        function computeRuns(messages) {
            const runs = [];
            for (let i = 0; i < messages.length; i += 1) {
                const m = messages[i];
                if (m.type === 'assistant') {
                    const start = parseIso(m.created_at);
                    let end = start;
                    let j = i + 1;
                    while (j < messages.length) {
                        const n = messages[j];
                        if (n.type === 'assistant' || n.type === 'user') break;
                        if (n.type === 'tool') {
                            const meta = typeof n.metadata === 'string' ? safeJsonParse(n.metadata) : (n.metadata || {});
                            if (meta && meta.assistant_message_id === m.message_id) {
                                end = parseIso(n.created_at);
                            }
                        }
                        j += 1;
                    }
                    runs.push({
                        run_id: (typeof m.metadata === 'string' ? safeJsonParse(m.metadata)?.thread_run_id : m.metadata?.thread_run_id) || null,
                        assistant_message_id: m.message_id,
                        start: start,
                        end: end,
                        duration_seconds: Math.max(0, (end - start) / 1000),
                    });
                    i = j - 1;
                }
            }
            return runs;
        }

        // ËÆ°ÁÆóÊ¥ªË∑ÉÂë®Êúü
        function computeCycles(messages) {
            const cycles = [];
            let currentUser = null;
            let lastNonUser = null;
            for (const m of messages) {
                if (m.type === 'user') {
                    if (currentUser && lastNonUser && lastNonUser >= parseIso(currentUser.created_at)) {
                        const start = parseIso(currentUser.created_at);
                        cycles.push({
                            trigger_user_message_id: currentUser.message_id,
                            start,
                            end: lastNonUser,
                            duration_seconds: (lastNonUser - start) / 1000,
                        });
                    }
                    currentUser = m;
                    lastNonUser = null;
                } else if (currentUser) {
                    lastNonUser = parseIso(m.created_at);
                }
            }
            if (currentUser && lastNonUser && lastNonUser >= parseIso(currentUser.created_at)) {
                const start = parseIso(currentUser.created_at);
                cycles.push({
                    trigger_user_message_id: currentUser.message_id,
                    start,
                    end: lastNonUser,
                    duration_seconds: (lastNonUser - start) / 1000,
                });
            }
            return cycles;
        }

        // Ê±áÊÄªÊó∂Èó¥Á™óÂè£
        function summarizeWindows(windows) {
            if (!windows.length) return { total: 0, start: null, end: null };
            const total = windows.reduce((s, w) => s + w.duration_seconds, 0);
            const start = new Date(Math.min(...windows.map(w => w.start.getTime())));
            const end = new Date(Math.max(...windows.map(w => w.end.getTime())));
            return { total, start, end };
        }

        // ÁîüÊàêCSV
        function toCsv(rows, headers) {
            const esc = v => {
                const s = String(v ?? '');
                if (/[",\n]/.test(s)) return '"' + s.replace(/"/g, '""') + '"';
                return s;
            };
            const head = headers.map(h => esc(h.label)).join(',');
            const body = rows.map(r => headers.map(h => esc(h.get(r))).join(',')).join('\n');
            return head + '\n' + body + '\n';
        }

        // ‰∏ãËΩΩÊñá‰ª∂
        function download(filename, text) {
            const blob = new Blob([text], { type: 'text/csv;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }

        // ÊòæÁ§∫ÊâπÈáèÂàÜÊûêÁªìÊûú
        function displayBatchResults(data) {
            const messages = data.data;
            const userMessages = messages.filter(m => m.type === 'user');
            
            let html = '<div class="batch-results">';
            
            userMessages.forEach((msg, index) => {
                const content = msg.content || '';
                const cleanContent = extractCleanPrompt(content);
                
                html += `
                    <div class="conversation-item">
                        <div class="conversation-header">
                            <span class="conversation-title">ÂØπËØù ${index + 1}</span>
                            <div class="conversation-stats">
                                <span>Ê∂àÊÅØID: ${msg.message_id}</span>
                                <span>Êó∂Èó¥: ${formatDate(parseIso(msg.created_at), currentTimezone)}</span>
                            </div>
                        </div>
                        <div class="initial-prompt">
                            <div class="prompt-label">üí¨ Áî®Êà∑ÂàùÂßãÊèêÁ§∫</div>
                            <div class="prompt-text">${cleanContent}</div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            document.getElementById('batch-content').innerHTML = html;
            document.getElementById('batch-results').classList.remove('hidden');
        }

        // ÊèêÂèñÂπ≤ÂáÄÁöÑPromptÊñáÊú¨
        function extractCleanPrompt(content) {
            console.log('extractCleanPrompt ËæìÂÖ•:', content);
            console.log('extractCleanPrompt ËæìÂÖ•Á±ªÂûã:', typeof content);
            
            if (!content) return 'Êó†ÂÜÖÂÆπ';
            
            let text = '';
            if (typeof content === 'string') {
                text = content;
                console.log('ÂéüÂßãÊñáÊú¨:', text);
                
                // Â∞ùËØïËß£ÊûêJSONÂ≠óÁ¨¶‰∏≤ÔºåÊèêÂèñcontentÂ≠óÊÆµ
                try {
                    const parsed = JSON.parse(text);
                    console.log('JSONËß£ÊûêÁªìÊûú:', parsed);
                    if (parsed && parsed.content) {
                        text = parsed.content;
                        console.log('ÊèêÂèñcontentÂ≠óÊÆµÂêé:', text);
                    }
                } catch (e) {
                    console.log('JSONËß£ÊûêÂ§±Ë¥•:', e.message);
                    // ‰∏çÊòØJSONÔºåÁªßÁª≠Â§ÑÁêÜÂéüÂßãÊñáÊú¨
                }
                
                // Â¶ÇÊûú‰ªçÁÑ∂ÊòØJSONÊ†ºÂºèÔºàÂ¶Ç{"role": "user", "content": "..."}ÔºâÔºåÂ∞ùËØïÊèêÂèñcontent
                if (text.includes('"content"')) {
                    try {
                        // ‰ΩøÁî®Ê≠£ÂàôË°®ËææÂºèÊèêÂèñcontentÂ≠óÊÆµÁöÑÂÄº
                        const contentMatch = text.match(/"content"\s*:\s*"([^"]+)"/);
                        console.log('Ê≠£ÂàôÂåπÈÖçÁªìÊûú:', contentMatch);
                        if (contentMatch) {
                            text = contentMatch[1];
                            console.log('Ê≠£ÂàôÊèêÂèñÂêé:', text);
                        }
                    } catch (e) {
                        console.log('Ê≠£ÂàôÊèêÂèñÂ§±Ë¥•:', e);
                        // ÊèêÂèñÂ§±Ë¥•Ôºå‰ΩøÁî®ÂéüÂßãÊñáÊú¨
                    }
                }
                
                // Â§ÑÁêÜËΩ¨‰πâÁöÑJSONÂ≠óÁ¨¶‰∏≤
                if (text.includes('\\"') && text.includes('"content\\"')) {
                    try {
                        // Â§ÑÁêÜËΩ¨‰πâÂ≠óÁ¨¶
                        const unescapedText = text.replace(/\\"/g, '"');
                        const escapedMatch = unescapedText.match(/"content"\s*:\s*"([^"]+)"/);
                        console.log('ËΩ¨‰πâÂ§ÑÁêÜÂåπÈÖçÁªìÊûú:', escapedMatch);
                        if (escapedMatch) {
                            text = escapedMatch[1];
                            console.log('ËΩ¨‰πâÂ§ÑÁêÜÂêé:', text);
                        }
                    } catch (e) {
                        console.log('ËΩ¨‰πâÂ§ÑÁêÜÂ§±Ë¥•:', e);
                    }
                }
            } else if (Array.isArray(content)) {
                text = content.map(item => {
                    if (typeof item === 'string') return item;
                    if (item.type === 'text') return item.text;
                    return '';
                }).join('');
            } else {
                text = String(content);
            }
            
            // Ê∏ÖÁêÜJSONÊ†ºÂºèÁöÑÂÖÉÊï∞ÊçÆ
            text = text.replace(/\n\n\[\"[^"]+\"(?:,\s*\"[^"]+\")*\]\s*$/g, '');
            text = text.replace(/^\[\"[^"]+\"(?:,\s*\"[^"]+\")*\]\s*\n\n/g, '');
            text = text.replace(/\n\n\[[^\]]+\]\s*$/g, '');
            text = text.replace(/\n{3,}/g, '\n\n');
            text = text.trim();
            
            console.log('ÊúÄÁªàÁªìÊûú:', text);
            return text || 'Êó†ÊúâÊïàÂÜÖÂÆπ';
        }

        // ÊòæÁ§∫Êó∂Èó¥ÂàÜÊûêÁªìÊûú
        function displayTimeResults(data) {
            const messages = data.data.map(msg => ({
                ...msg,
                parsedDate: parseIso(msg.created_at)
            })).sort((a, b) => a.parsedDate - b.parsedDate);

            const runs = computeRuns(messages);
            const cycles = computeCycles(messages);
            const first = messages[0].parsedDate;
            const last = messages[messages.length - 1].parsedDate;
            const runSum = summarizeWindows(runs);
            const cycleSum = summarizeWindows(cycles);

            let html = `
                <div class="time-summary">
                    <div class="summary-item">
                        <div class="summary-value">${messages.length}</div>
                        <div class="summary-label">ÊÄªÊ∂àÊÅØÊï∞</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-value">${cycleSum.total.toFixed(3)}s</div>
                        <div class="summary-label">Ê¥ªË∑ÉÂë®ÊúüÊÄªÊó∂Èó¥</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-value">${runSum.total.toFixed(3)}s</div>
                        <div class="summary-label">LLMËøêË°åÊÄªÊó∂Èó¥</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-value">${runs.length}</div>
                        <div class="summary-label">LLMËøêË°åÊ¨°Êï∞</div>
                    </div>
                </div>
            `;

            // ËøêË°åÊó∂Èó¥Ë°®Ê†º
            if (runs.length > 0) {
                html += `
                    <h3>LLMËøêË°åÁ™óÂè£</h3>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>ËøêË°åID</th>
                                    <th>Âä©ÊâãÊ∂àÊÅØID</th>
                                    <th>ÂºÄÂßã</th>
                                    <th>ÁªìÊùü</th>
                                    <th>ÊåÅÁª≠Êó∂Èó¥(Áßí)</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                runs.forEach((run, i) => {
                    html += `
                        <tr>
                            <td>${i + 1}</td>
                            <td>${run.run_id || '-'}</td>
                            <td>${run.assistant_message_id}</td>
                            <td>${formatDate(run.start, currentTimezone)}</td>
                            <td>${formatDate(run.end, currentTimezone)}</td>
                            <td>${run.duration_seconds.toFixed(3)}</td>
                        </tr>
                    `;
                });
                
                html += `
                            </tbody>
                        </table>
                    </div>
                `;
            }

            // Ê¥ªË∑ÉÂë®ÊúüË°®Ê†º
            if (cycles.length > 0) {
                html += `
                    <h3>LLMÊ¥ªË∑ÉÂë®Êúü</h3>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Ëß¶ÂèëÁî®Êà∑Ê∂àÊÅØID</th>
                                    <th>ÂºÄÂßã</th>
                                    <th>ÁªìÊùü</th>
                                    <th>ÊåÅÁª≠Êó∂Èó¥(Áßí)</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                cycles.forEach((cycle, i) => {
                    html += `
                        <tr>
                            <td>${i + 1}</td>
                            <td>${cycle.trigger_user_message_id}</td>
                            <td>${formatDate(cycle.start, currentTimezone)}</td>
                            <td>${formatDate(cycle.end, currentTimezone)}</td>
                            <td>${cycle.duration_seconds.toFixed(3)}</td>
                        </tr>
                    `;
                });
                
                html += `
                            </tbody>
                        </table>
                    </div>
                `;
            }

            console.log('Ê≠£Âú®Êõ¥Êñ∞Êó∂Èó¥ÂàÜÊûêÁªìÊûú...');
            console.log('ÁîüÊàêÁöÑÊó∂Èó¥ÂàÜÊûêHTMLÈïøÂ∫¶:', html.length);
            const timeContent = document.getElementById('time-content');
            const timeResults = document.getElementById('time-results');
            
            console.log('Êó∂Èó¥ÂàÜÊûêDOMÂÖÉÁ¥†Êü•ÊâæÁªìÊûú:', {
                timeContent: !!timeContent,
                timeResults: !!timeResults,
                timeContentId: timeContent ? timeContent.id : 'not found',
                timeResultsId: timeResults ? timeResults.id : 'not found'
            });
            
            if (timeContent && timeResults) {
                console.log('ËÆæÁΩÆÊó∂Èó¥ÂàÜÊûêinnerHTML...');
                timeContent.innerHTML = html;
                console.log('ÁßªÈô§Êó∂Èó¥ÂàÜÊûêhiddenÁ±ª...');
                timeResults.classList.remove('hidden');
                console.log('Êó∂Èó¥ÂàÜÊûêÁªìÊûúÂ∑≤ÊòæÁ§∫');
            } else {
                console.error('Êó∂Èó¥ÂàÜÊûêÁªìÊûúÂÖÉÁ¥†Êú™ÊâæÂà∞:', {
                    timeContent: !!timeContent,
                    timeResults: !!timeResults,
                    allElements: document.querySelectorAll('[id*="time"]').length
                });
            }
        }

        // ÊòæÁ§∫ÂØπËØùÂèØËßÜÂåñÁªìÊûú
        function displayVizResults(data) {
            const messages = data.data.map(msg => ({
                ...msg,
                parsedDate: parseIso(msg.created_at)
            })).sort((a, b) => a.parsedDate - b.parsedDate);

            const userMessages = messages.filter(m => m.type === 'user');
            const assistantMessages = messages.filter(m => m.type === 'assistant');
            const toolMessages = messages.filter(m => m.type === 'tool');

            // ÁªüËÆ°‰ø°ÊÅØ
            const statsHtml = `
                <div class="viz-stats">
                    <div class="viz-stat">
                        <div class="viz-stat-value">${messages.length}</div>
                        <div class="viz-stat-label">ÊÄªÊ∂àÊÅØÊï∞</div>
                    </div>
                    <div class="viz-stat">
                        <div class="viz-stat-value">${userMessages.length}</div>
                        <div class="viz-stat-label">Áî®Êà∑Ê∂àÊÅØ</div>
                    </div>
                    <div class="viz-stat">
                        <div class="viz-stat-value">${assistantMessages.length}</div>
                        <div class="viz-stat-label">Âä©ÊâãÊ∂àÊÅØ</div>
                    </div>
                    <div class="viz-stat">
                        <div class="viz-stat-value">${toolMessages.length}</div>
                        <div class="viz-stat-label">Â∑•ÂÖ∑Ê∂àÊÅØ</div>
                    </div>
                </div>
            `;

            // Ê∂àÊÅØÁ≠õÈÄâÂô®
            const filterHtml = `
                <div class="message-filter">
                    <div class="filter-title">Á≠õÈÄâÊ∂àÊÅØÁ±ªÂûã:</div>
                    <div class="filter-options">
                        <div class="filter-option">
                            <input type="checkbox" id="filter-user" checked onchange="filterMessages()">
                            <label for="filter-user">Áî®Êà∑Ê∂àÊÅØ (${userMessages.length})</label>
                        </div>
                        <div class="filter-option">
                            <input type="checkbox" id="filter-assistant" checked onchange="filterMessages()">
                            <label for="filter-assistant">Âä©ÊâãÊ∂àÊÅØ (${assistantMessages.length})</label>
                        </div>
                        <div class="filter-option">
                            <input type="checkbox" id="filter-tool" checked onchange="filterMessages()">
                            <label for="filter-tool">Â∑•ÂÖ∑Ê∂àÊÅØ (${toolMessages.length})</label>
                        </div>
                    </div>
                </div>
            `;

            // ÂØπËØùÊó∂Èó¥Á∫ø
            let timelineHtml = '<div class="conversation-viz" id="conversation-timeline">';
            
            messages.forEach((msg, index) => {
                const content = msg.content || '';
                const cleanContent = extractCleanPrompt(content);
                const messageId = `msg-${index}`;
                
                timelineHtml += `
                    <div class="message ${msg.type}" data-type="${msg.type}" id="${messageId}">
                        <div class="message-header">
                            <span class="message-type ${msg.type}">${getTypeLabel(msg.type)}</span>
                            <span class="message-time">${formatDate(msg.parsedDate, currentTimezone)}</span>
                            <button class="metadata-toggle" onclick="toggleMetadata('${messageId}')">Êü•ÁúãÂÖÉÊï∞ÊçÆ</button>
                        </div>
                        <div class="message-content">
                            ${cleanContent}
                        </div>
                        <div class="message-metadata" id="${messageId}-metadata">
                            <div class="metadata-item">
                                <span class="metadata-label">Ê∂àÊÅØID:</span>
                                <span class="metadata-value">${msg.message_id || 'Êó†'}</span>
                            </div>
                            <div class="metadata-item">
                                <span class="metadata-label">Á∫øÁ®ãID:</span>
                                <span class="metadata-value">${msg.thread_id || 'Êó†'}</span>
                            </div>
                            <div class="metadata-item">
                                <span class="metadata-label">ÂàõÂª∫Êó∂Èó¥:</span>
                                <span class="metadata-value">${msg.created_at}</span>
                            </div>
                            ${msg.metadata ? `
                            <div class="metadata-item">
                                <span class="metadata-label">ÂÖÉÊï∞ÊçÆ:</span>
                                <span class="metadata-value">${JSON.stringify(msg.metadata, null, 2)}</span>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            });
            
            timelineHtml += '</div>';

            console.log('Ê≠£Âú®Êõ¥Êñ∞ÂØπËØùÂèØËßÜÂåñÁªìÊûú...');
            console.log('ÁîüÊàêÁöÑHTMLÈïøÂ∫¶:', statsHtml.length + filterHtml.length + timelineHtml.length);
            const vizContent = document.getElementById('viz-content');
            const vizResults = document.getElementById('viz-results');
            
            console.log('DOMÂÖÉÁ¥†Êü•ÊâæÁªìÊûú:', {
                vizContent: !!vizContent,
                vizResults: !!vizResults,
                vizContentId: vizContent ? vizContent.id : 'not found',
                vizResultsId: vizResults ? vizResults.id : 'not found'
            });
            
            if (vizContent && vizResults) {
                console.log('ËÆæÁΩÆinnerHTML...');
                // ÂàùÂßãÂåñÂÆπÂô®‰∏é‚ÄúÂä†ËΩΩÊõ¥Â§ö‚ÄùÊåâÈíÆ
                const initialHtml = statsHtml + filterHtml + '<div class="conversation-viz" id="conversation-timeline"></div>' + '<div id="viz-load-more-wrap" style="text-align:center;margin:12px 0;"><button id="viz-load-more" class="export-btn">Âä†ËΩΩÊõ¥Â§ö</button></div>';
                vizContent.innerHTML = initialHtml;
                console.log('ÁßªÈô§hiddenÁ±ª...');
                vizResults.classList.remove('hidden');

                // Â≠òÂÇ®Ê∂àÊÅØÊï∞ÊçÆ‰æõÁ≠õÈÄâ/ÂàÜÈ°µ‰ΩøÁî®
                window.currentVizMessages = messages;
                window._vizRenderedCount = 0;
                window._vizBatchSize = 100; // ÊØèÊâπÊ∏≤Êüì100Êù°ÔºåÈÅøÂÖç‰∏ÄÊ¨°ÊÄßÂ§ßDOM

                function renderMoreMessages() {
                    const container = document.getElementById('conversation-timeline');
                    const start = window._vizRenderedCount;
                    const end = Math.min(start + window._vizBatchSize, window.currentVizMessages.length);
                    if (!container || start >= end) return;

                    let chunkHtml = '';
                    for (let index = start; index < end; index += 1) {
                        const msg = window.currentVizMessages[index];
                        const content = msg.content || '';
                        const cleanContent = extractCleanPrompt(content);
                        const messageId = `msg-${index}`;
                        chunkHtml += `
                            <div class="message ${msg.type}" data-type="${msg.type}" id="${messageId}">
                                <div class="message-header">
                                    <span class="message-type ${msg.type}">${getTypeLabel(msg.type)}</span>
                                    <span class="message-time">${formatDate(msg.parsedDate, currentTimezone)}</span>
                                    <button class="metadata-toggle" onclick="toggleMetadata('${messageId}')">Êü•ÁúãÂÖÉÊï∞ÊçÆ</button>
                                </div>
                                <div class="message-content">${cleanContent}</div>
                                <div class="message-metadata" id="${messageId}-metadata">
                                    <div class="metadata-item"><span class="metadata-label">Ê∂àÊÅØID:</span><span class="metadata-value">${msg.message_id || 'Êó†'}</span></div>
                                    <div class="metadata-item"><span class="metadata-label">Á∫øÁ®ãID:</span><span class="metadata-value">${msg.thread_id || 'Êó†'}</span></div>
                                    <div class="metadata-item"><span class="metadata-label">ÂàõÂª∫Êó∂Èó¥:</span><span class="metadata-value">${msg.created_at}</span></div>
                                    ${msg.metadata ? `<div class="metadata-item"><span class="metadata-label">ÂÖÉÊï∞ÊçÆ:</span><span class="metadata-value">${JSON.stringify(msg.metadata, null, 2)}</span></div>` : ''}
                                </div>
                            </div>`;
                    }
                    container.insertAdjacentHTML('beforeend', chunkHtml);
                    window._vizRenderedCount = end;

                    // ÊéßÂà∂"Âä†ËΩΩÊõ¥Â§ö"ÊåâÈíÆÂèØËßÅÊÄß
                    const btn = document.getElementById('viz-load-more');
                    if (btn) {
                        if (window._vizRenderedCount >= window.currentVizMessages.length) {
                            btn.disabled = true;
                            btn.textContent = 'ÂÖ®ÈÉ®Âä†ËΩΩÂÆåÊàê';
                        } else {
                            btn.disabled = false;
                            btn.textContent = 'Âä†ËΩΩÊõ¥Â§ö';
                        }
                    }
                    
                    // ‰øÆÂ§çÈ°µÈù¢ÊªöÂä®ÈóÆÈ¢ò
                    setTimeout(() => {
                        document.body.style.overflow = '';
                        document.documentElement.style.overflow = '';
                        document.body.style.position = '';
                        document.documentElement.style.position = '';
                        document.body.style.height = '';
                        document.documentElement.style.height = '';
                        
                        // Á°Æ‰øùÈ°µÈù¢ÂèØ‰ª•Ê≠£Â∏∏ÊªöÂä®
                        const pageHeight = Math.max(
                            document.body.scrollHeight,
                            document.body.offsetHeight,
                            document.documentElement.clientHeight,
                            document.documentElement.scrollHeight,
                            document.documentElement.offsetHeight
                        );
                        
                        if (pageHeight > window.innerHeight) {
                            document.body.style.overflowY = 'auto';
                            document.documentElement.style.overflowY = 'auto';
                        }
                        
                        console.log('Âä†ËΩΩÊõ¥Â§öÊ∂àÊÅØÂêéÈ°µÈù¢ÊªöÂä®‰øÆÂ§çÂÆåÊàêÔºåÈ°µÈù¢È´òÂ∫¶:', pageHeight, 'Á™óÂè£È´òÂ∫¶:', window.innerHeight);
                    }, 50);
                }

                // ÁªëÂÆöÂä†ËΩΩÊõ¥Â§ö
                const loadMoreBtn = document.getElementById('viz-load-more');
                if (loadMoreBtn) {
                    loadMoreBtn.addEventListener('click', () => {
                        renderMoreMessages();
                    });
                }

                // È¶ñÊ¨°Ê∏≤Êüì‰∏ÄÊâπ
                renderMoreMessages();

                console.log('ÂØπËØùÂèØËßÜÂåñÁªìÊûúÂ∑≤ÊòæÁ§∫');
            } else {
                console.error('ÂØπËØùÂèØËßÜÂåñÁªìÊûúÂÖÉÁ¥†Êú™ÊâæÂà∞:', {
                    vizContent: !!vizContent,
                    vizResults: !!vizResults,
                    allElements: document.querySelectorAll('[id*="viz"]').length
                });
            }
        }

        // ÂàáÊç¢metadataÊòæÁ§∫
        function toggleMetadata(messageId) {
            const metadata = document.getElementById(`${messageId}-metadata`);
            const toggle = document.querySelector(`#${messageId} .metadata-toggle`);
            
            if (metadata.classList.contains('show')) {
                metadata.classList.remove('show');
                toggle.textContent = 'Êü•ÁúãÂÖÉÊï∞ÊçÆ';
                toggle.classList.remove('expanded');
            } else {
                metadata.classList.add('show');
                toggle.textContent = 'ÈöêËóèÂÖÉÊï∞ÊçÆ';
                toggle.classList.add('expanded');
            }
        }

        // Á≠õÈÄâÊ∂àÊÅØ
        function filterMessages() {
            const showUser = document.getElementById('filter-user').checked;
            const showAssistant = document.getElementById('filter-assistant').checked;
            const showTool = document.getElementById('filter-tool').checked;
            
            const messages = document.querySelectorAll('#conversation-timeline .message');
            
            messages.forEach(msg => {
                const type = msg.getAttribute('data-type');
                let shouldShow = false;
                
                if (type === 'user' && showUser) shouldShow = true;
                if (type === 'assistant' && showAssistant) shouldShow = true;
                if (type === 'tool' && showTool) shouldShow = true;
                
                if (shouldShow) {
                    msg.classList.remove('hidden');
                } else {
                    msg.classList.add('hidden');
                }
            });
            
            // ‰øÆÂ§çÈ°µÈù¢ÊªöÂä®ÈóÆÈ¢ò
            setTimeout(() => {
                document.body.style.overflow = '';
                document.documentElement.style.overflow = '';
                document.body.style.position = '';
                document.documentElement.style.position = '';
                document.body.style.height = '';
                document.documentElement.style.height = '';
                
                // Á°Æ‰øùÈ°µÈù¢ÂèØ‰ª•Ê≠£Â∏∏ÊªöÂä®
                const pageHeight = Math.max(
                    document.body.scrollHeight,
                    document.body.offsetHeight,
                    document.documentElement.clientHeight,
                    document.documentElement.scrollHeight,
                    document.documentElement.offsetHeight
                );
                
                if (pageHeight > window.innerHeight) {
                    document.body.style.overflowY = 'auto';
                    document.documentElement.style.overflowY = 'auto';
                }
                
                console.log('Ê∂àÊÅØÁ≠õÈÄâÂêéÈ°µÈù¢ÊªöÂä®‰øÆÂ§çÂÆåÊàêÔºåÈ°µÈù¢È´òÂ∫¶:', pageHeight, 'Á™óÂè£È´òÂ∫¶:', window.innerHeight);
            }, 50);
        }

        // Ëé∑ÂèñÁ±ªÂûãÊ†áÁ≠æ
        function getTypeLabel(type) {
            const labels = {
                'user': 'Áî®Êà∑',
                'assistant': 'Âä©Êâã',
                'tool': 'Â∑•ÂÖ∑'
            };
            return labels[type] || type;
        }

        // ‰∏ªË¶ÅÂàÜÊûêÂáΩÊï∞ÔºàÂçïÊ¨°ÂàÜÊûêÔºâ
        async function analyzeData() {
            try {
                console.log('analyzeData Ë¢´Ë∞ÉÁî®ÔºåÂΩìÂâçÊ®°Âºè:', currentInputMode);
                console.log('ÂΩìÂâçËæìÂÖ•ÊñπÊ≥ï:', currentInputMethod);
                
                // Â¶ÇÊûúÊòØÊâπÈáèÂàÜÊûêÊ®°ÂºèÔºåË∞ÉÁî®ÊâπÈáèÂàÜÊûêÂáΩÊï∞
                if (currentInputMode === 'batch') {
                    console.log('Ê£ÄÊµãÂà∞ÊâπÈáèÂàÜÊûêÊ®°ÂºèÔºåÂêØÂä®ÊâπÈáèÂàÜÊûê...');
                    console.log('ÂΩìÂâçÊâπÈáèURLÊï∞Èáè:', getBatchUrls().length);
                    console.log('ÂΩìÂâçÊâπÈáèJSONÊï∞Èáè:', getBatchJsonData().length);
                    await analyzeBatchData();
                    return;
                }
                
                // ÂçïÊ¨°ÂàÜÊûêÊ®°Âºè
                let data;
                if (currentInputMethod === 'url') {
                    console.log('Ê≠£Âú®‰ªéURLËé∑ÂèñÊï∞ÊçÆ...');
                    data = await fetchData();
                    console.log('URLÊï∞ÊçÆËé∑ÂèñÊàêÂäü:', data);
                } else {
                    const jsonText = document.getElementById('json-input').value.trim();
                    if (!jsonText) {
                        showStatus('ËØ∑ËæìÂÖ•JSONÊï∞ÊçÆ', 'error');
                        return;
                    }
                    data = safeJsonParse(jsonText);
                    if (!data) {
                        showStatus('JSONÊ†ºÂºèÈîôËØØ', 'error');
                        return;
                    }
                    console.log('JSONÊï∞ÊçÆËß£ÊûêÊàêÂäü:', data);
                    showStatus('Êï∞ÊçÆËß£ÊûêÊàêÂäüÔºÅ', 'success');
                }

                // È™åËØÅÊï∞ÊçÆÊ†ºÂºè
                if (!data || !Array.isArray(data.data)) {
                    showStatus('Êï∞ÊçÆÊ†ºÂºèÈîôËØØÔºöÊúüÊúõ { data: [...] }', 'error');
                    return;
                }

                console.log('Êï∞ÊçÆÊ†ºÂºèÈ™åËØÅÈÄöËøáÔºåÊ∂àÊÅØÊï∞Èáè:', data.data.length);

                currentData = data;
                currentTimezone = document.getElementById('timezone-select-single').value;

                // Ëé∑ÂèñÈÄâ‰∏≠ÁöÑÂàÜÊûêÁ±ªÂûã
                const includeBatch = document.getElementById('include-batch-single').checked;
                const includeTime = document.getElementById('include-time-single').checked;
                const includeViz = document.getElementById('include-viz-single').checked;

                console.log('ÈÄâ‰∏≠ÁöÑÂàÜÊûêÁ±ªÂûã - ÊâπÈáè:', includeBatch, 'Êó∂Èó¥:', includeTime, 'ÂØπËØù:', includeViz);

                // È™åËØÅËá≥Â∞ëÈÄâÊã©‰∫Ü‰∏ÄÁßçÂàÜÊûêÁ±ªÂûã
                if (!includeBatch && !includeTime && !includeViz) {
                    showStatus('ËØ∑Ëá≥Â∞ëÈÄâÊã©‰∏ÄÁßçÂàÜÊûêÁ±ªÂûã', 'error');
                    return;
                }

                // Âú®ÂçïÊ¨°ÂàÜÊûêÊ®°Âºè‰∏ãÔºåÊòæÁ§∫ÁÆÄÊ¥ÅÁöÑPrompt‰ø°ÊÅØ
                if (currentInputMode === 'single') {
                    console.log('ÊòæÁ§∫ÂçïÊ¨°ÂàÜÊûêPrompt...');
                    displaySinglePrompt(data);
                    
                    // ÊòæÁ§∫ÂçïÊ¨°ÂàÜÊûêÁªìÊûúÂå∫Âüü
                    console.log('ÊòæÁ§∫ÂçïÊ¨°ÂàÜÊûêÁªìÊûúÂå∫Âüü...');
                    const singleResultsSection = document.getElementById('single-results-section');
                    if (singleResultsSection) {
                        singleResultsSection.classList.remove('hidden');
                        console.log('ÂçïÊ¨°ÂàÜÊûêÁªìÊûúÂå∫ÂüüÂ∑≤ÊòæÁ§∫');
                    } else {
                        console.error('Êú™ÊâæÂà∞single-results-sectionÂÖÉÁ¥†');
                    }
                }

                // ÊòæÁ§∫ÂàÜÊûêÁªìÊûú
                if (includeTime) {
                    console.log('ÊòæÁ§∫Êó∂Èó¥ÂàÜÊûêÁªìÊûú...');
                    displayTimeResults(data);
                }
                if (includeViz) {
                    console.log('ÊòæÁ§∫ÂØπËØùÂèØËßÜÂåñÁªìÊûú...');
                    displayVizResults(data);
                }

                // Âú®ÊâπÈáèÂàÜÊûêÊ®°Âºè‰∏ãÊâçÊòæÁ§∫ÊâπÈáèÁªìÊûú
                if (includeBatch && currentInputMode === 'batch') {
                    console.log('ÊòæÁ§∫ÊâπÈáèÂàÜÊûêÁªìÊûú...');
                    displayBatchResults(data);
                }

                console.log('ÂàÜÊûêÂÆåÊàê');
                showStatus('ÂàÜÊûêÂÆåÊàêÔºÅ', 'success');
                
                // ‰øÆÂ§çÈ°µÈù¢ÊªöÂä®ÈóÆÈ¢ò
                setTimeout(() => {
                    document.body.style.overflow = '';
                    document.documentElement.style.overflow = '';
                    document.body.style.position = '';
                    document.documentElement.style.position = '';
                    document.body.style.height = '';
                    document.documentElement.style.height = '';
                    
                    // Á°Æ‰øùÈ°µÈù¢ÂèØ‰ª•Ê≠£Â∏∏ÊªöÂä®
                    const pageHeight = Math.max(
                        document.body.scrollHeight,
                        document.body.offsetHeight,
                        document.documentElement.clientHeight,
                        document.documentElement.scrollHeight,
                        document.documentElement.offsetHeight
                    );
                    
                    if (pageHeight > window.innerHeight) {
                        document.body.style.overflowY = 'auto';
                        document.documentElement.style.overflowY = 'auto';
                    }
                    
                    console.log('È°µÈù¢ÊªöÂä®‰øÆÂ§çÂÆåÊàêÔºåÈ°µÈù¢È´òÂ∫¶:', pageHeight, 'Á™óÂè£È´òÂ∫¶:', window.innerHeight);
                }, 100);

            } catch (error) {
                console.error('ÂàÜÊûêÂ§±Ë¥•:', error);
                showStatus(`ÂàÜÊûêÂ§±Ë¥•: ${error.message}`, 'error');
            }
        }

        // ÊòæÁ§∫ÂçïÊ¨°ÂàÜÊûêÁöÑÁÆÄÊ¥ÅPrompt
        function displaySinglePrompt(data) {
            console.log('ÂºÄÂßãÊòæÁ§∫ÂçïÊ¨°ÂàÜÊûêPrompt...');
            const userMessages = data.data.filter(m => m.type === 'user');
            console.log('ÊâæÂà∞Áî®Êà∑Ê∂àÊÅØÊï∞Èáè:', userMessages.length);
            
            if (userMessages.length > 0) {
                const firstUserMessage = userMessages[0];
                const cleanPrompt = extractCleanPrompt(firstUserMessage.content || '');
                console.log('ÊèêÂèñÁöÑClean PromptÈïøÂ∫¶:', cleanPrompt.length);
                
                // Ëé∑ÂèñÁî®Êà∑ËæìÂÖ•ÁöÑURL
                let sourceUrl = '';
                if (currentInputMethod === 'url') {
                    sourceUrl = document.getElementById('url-input').value.trim();
                } else if (currentInputMethod === 'json') {
                    // ÂØπ‰∫éJSONËæìÂÖ•ÔºåÂ∞ùËØï‰ªémetadata‰∏≠Ëé∑Âèñsource_url
                    sourceUrl = firstUserMessage.metadata?.source_url || '';
                }
                
                console.log('Ê∫êURL:', sourceUrl);
                
                // ÂàõÂª∫Áî®Êà∑ÊèêÁ§∫Ê†áÈ¢òÔºåÂ¶ÇÊûúÊòØURLÂàôÊ∑ªÂä†ÈìæÊé•
                let promptTitle = 'üí¨ Áî®Êà∑ÊèêÁ§∫';
                if (sourceUrl) {
                    promptTitle = `üí¨ <a href="${sourceUrl}" target="_blank" class="prompt-link" title="ÁÇπÂáªÊü•ÁúãÂéüÂßãÂØπËØù">Áî®Êà∑ÊèêÁ§∫</a>`;
                }
                
                const promptHtml = `
                    <div class="single-prompt-display">
                        <div class="prompt-header">
                            <h3>${promptTitle}</h3>
                            <span class="prompt-time">${formatDate(parseIso(firstUserMessage.created_at), currentTimezone)}</span>
                        </div>
                        <div class="prompt-content">${cleanPrompt}</div>
                    </div>
                `;
                
                console.log('ÁîüÊàêÁöÑPrompt HTMLÈïøÂ∫¶:', promptHtml.length);
                
                // Âú®Êó∂Èó¥ÂàÜÊûêÁªìÊûú‰πãÂâçÊèíÂÖ•PromptÊòæÁ§∫
                const timeResults = document.getElementById('time-results');
                console.log('Êü•Êâætime-resultsÂÖÉÁ¥†:', !!timeResults);
                
                if (timeResults) {
                    console.log('ÊèíÂÖ•Prompt HTML...');
                    timeResults.insertAdjacentHTML('beforebegin', promptHtml);
                    console.log('ÂçïÊ¨°ÂàÜÊûêPromptÂ∑≤ÊòæÁ§∫');
                } else {
                    console.error('Êú™ÊâæÂà∞time-resultsÂÖÉÁ¥†ÔºåÊó†Ê≥ïÊòæÁ§∫Prompt');
                }
            }
        }

        // ÂØºÂá∫ÂäüËÉΩ
        function exportBatchResults() {
            if (!currentData) return;
            
            const messages = currentData.data.filter(m => m.type === 'user');
            let csv = 'ÂØπËØùÂ∫èÂè∑,Ê∂àÊÅØID,Êó∂Èó¥,Áî®Êà∑ÊèêÁ§∫\n';
            
            messages.forEach((msg, index) => {
                const content = extractCleanPrompt(msg.content || '');
                const time = formatDate(parseIso(msg.created_at), currentTimezone);
                csv += `${index + 1},${msg.message_id},"${time}","${content.replace(/"/g, '""')}"\n`;
            });
            
            download('batch-analysis.csv', csv);
        }

        function exportTimeResults() {
            if (!currentData) return;
            
            const messages = currentData.data.map(msg => ({
                ...msg,
                parsedDate: parseIso(msg.created_at)
            })).sort((a, b) => a.parsedDate - b.parsedDate);
            
            const runs = computeRuns(messages);
            const cycles = computeCycles(messages);
            
            let csv = 'LLMËøêË°åÁ™óÂè£\n';
            csv += toCsv(runs, [
                { label: '#', get: (_r, i) => i + 1 },
                { label: 'run_id', get: r => r.run_id || '' },
                { label: 'assistant_message_id', get: r => r.assistant_message_id },
                { label: 'start', get: r => r.start.toISOString() },
                { label: 'end', get: r => r.end.toISOString() },
                { label: 'duration_seconds', get: r => r.duration_seconds.toFixed(3) },
            ]);
            
            csv += '\nLLMÊ¥ªË∑ÉÂë®Êúü\n';
            csv += toCsv(cycles, [
                { label: '#', get: (_r, i) => i + 1 },
                { label: 'trigger_user_message_id', get: r => r.trigger_user_message_id },
                { label: 'start', get: r => r.start.toISOString() },
                { label: 'end', get: r => r.end.toISOString() },
                { label: 'duration_seconds', get: r => r.duration_seconds.toFixed(3) },
            ]);
            
            download('time-analysis.csv', csv);
        }

        // Êó∂Âå∫ÂàáÊç¢‰∫ã‰ª∂
        document.getElementById('timezone-select-single')?.addEventListener('change', function() {
            currentTimezone = this.value;
            if (currentData) {
                displayTimeResults(currentData);
                displayVizResults(currentData);
            }
        });

        document.getElementById('timezone-select-viz').addEventListener('change', function() {
            currentTimezone = this.value;
            if (currentData) {
                displayVizResults(currentData);
            }
        });

        // ÂõûËΩ¶ÈîÆÊîØÊåÅ
        document.getElementById('url-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                analyzeData();
            }
        });

        // ÊãñÊãΩ‰∏ä‰º†ÊîØÊåÅÔºà‰ªÖÂú®Á°ÆÂÆûÊãñÂÖ•Êñá‰ª∂Êó∂ÈòªÊ≠¢ÈªòËÆ§Ë°å‰∏∫ÔºåÈÅøÂÖçÂΩ±ÂìçÈ°µÈù¢ÊªöÂä®Ôºâ
        function isFileDragEvent(evt) {
            try {
                const dt = evt && evt.dataTransfer;
                if (!dt || !dt.types) return false;
                // Safari/Firefox/Chrome: types ÂèØËÉΩ‰∏∫ DOMStringList ÊàñÊï∞ÁªÑ
                const types = Array.from(dt.types);
                return types.includes('Files');
            } catch (_) {
                return false;
            }
        }

        document.addEventListener('dragover', (e) => {
            if (isFileDragEvent(e)) {
                e.preventDefault();
            }
        }, { passive: false });

        document.addEventListener('drop', async (e) => {
            if (!isFileDragEvent(e)) return;
            e.preventDefault();
            const f = e.dataTransfer.files && e.dataTransfer.files[0];
            if (!f) return;
            try {
                const text = await f.text();
                document.getElementById('json-input').value = text;
                switchInputMethod('json');
                showStatus('Êñá‰ª∂Â∑≤Âä†ËΩΩÔºåÁÇπÂáªÂàÜÊûêÊåâÈíÆÂºÄÂßã', 'success');
            } catch (error) {
                showStatus('Êñá‰ª∂ËØªÂèñÂ§±Ë¥•', 'error');
            }
        }, { passive: false });
        
        // È°µÈù¢Âä†ËΩΩÂÆåÊàêÂêéÂàùÂßãÂåñ
        window.addEventListener('DOMContentLoaded', function() {
            // ÈªòËÆ§ÊòæÁ§∫ÂçïÊ¨°ÂàÜÊûêÊ®°Âºè
            switchInputMode('single');
            // ÂàùÂßãÂåñURLÊï∞ÈáèÊòæÁ§∫
            updateUrlCountBadge();
        });

        // ÊäòÂè†ÂäüËÉΩ
        function toggleCollapsible(id) {
            const content = document.getElementById(`${id}-content`);
            const toggle = document.getElementById(`${id}-toggle`);
            
            if (content.classList.contains('expanded')) {
                content.classList.remove('expanded');
                toggle.classList.remove('expanded');
                toggle.textContent = '‚ñ∂';
            } else {
                content.classList.add('expanded');
                toggle.classList.add('expanded');
                toggle.textContent = '‚ñº';
            }
        }
    </script>
</body>
</html>